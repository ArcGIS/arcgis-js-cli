import"../main.js";import"./featureConversionUtils-0e5f7c52.js";import"./definitions-5e24d82a.js";import{r as t}from"./RenderingContext-81847018.js";import"./Utils-b46864a6.js";import"./earcut-69661edf.js";import"./GeometryUtils-2b0c8e16.js";import"./VertexArrayObject-17b5c9bd.js";import"./ShaderCompiler-2335fa5a.js";import"./Container-c6c95dc1.js";import"./mat4f32-a7ddfa75.js";import{a as i}from"./WGLContainer-720c8185.js";import"./MaterialKey-a89f5ca3.js";const e=[1,0],s=[0,1],r=[1,.8,.6,.4,.2],o=[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1];class n{constructor(){this._intensityFBO=null,this._compositeFBO=null,this._mipsFBOs=new Array(5),this._nMips=5,this._kernelSizeArray=[3,5,7,9,11],this._size=[0,0],this._programDesc={luminosityHighPass:{vsPath:"post-processing/pp",fsPath:"post-processing/bloom/luminosityHighPass",attributes:{a_position:0}},gaussianBlur:{vsPath:"post-processing/pp",fsPath:"post-processing/bloom/gaussianBlur",attributes:{a_position:0}},composite:{vsPath:"post-processing/pp",fsPath:"post-processing/bloom/composite",attributes:{a_position:0}},blit:{vsPath:"post-processing/pp",fsPath:"post-processing/blit",attributes:{a_position:0}}}}dispose(){if(this._quad&&(this._quad.dispose(),this._quad=null),this._intensityFBO&&(this._intensityFBO.dispose(),this._intensityFBO=null),this._compositeFBO&&(this._compositeFBO.dispose(),this._compositeFBO=null),this._mipsFBOs){for(let t=0;t<this._nMips;t++)this._mipsFBOs[t]&&(this._mipsFBOs[t].horizontal.dispose(),this._mipsFBOs[t].vertical.dispose());this._mipsFBOs=null}}draw(t,n,a){const{context:l,state:h,painter:p,pixelRatio:u}=t,{size:m}=h,{materialManager:d}=p,c=l.gl,_=this._programDesc,f=Math.round(u*m[0]),g=Math.round(u*m[1]),{strength:b,radius:F,threshold:B}=a;this._quad||(this._quad=new i(l,[-1,-1,1,-1,-1,1,1,1])),this._createOrResizeResources(t),l.setStencilTestEnabled(!1),l.setBlendingEnabled(!0),l.setBlendFunction(1,771),l.setStencilWriteMask(0);const O=this._quad;O.bind(),l.bindFramebuffer(this._intensityFBO);const T=d.getProgram(t,_.luminosityHighPass);l.bindProgram(T),l.bindTexture(n.colorTexture,0),T.setUniform1i("u_texture",0),T.setUniform3fv("u_defaultColor",[0,0,0]),T.setUniform1f("u_defaultOpacity",0),T.setUniform1f("u_luminosityThreshold",B),T.setUniform1f("u_smoothWidth",.01);const x=[Math.round(f/2),Math.round(g/2)];l.setViewport(0,0,x[0],x[1]),l.setClearColor(0,0,0,0),l.clear(c.COLOR_BUFFER_BIT),O.draw(),l.setBlendingEnabled(!1);let w=this._intensityFBO.colorTexture;for(let i=0;i<this._nMips;i++){const r=d.getProgram(t,_.gaussianBlur,[{name:"radius",value:this._kernelSizeArray[i]}]);l.bindProgram(r),l.bindTexture(w,i+1),r.setUniform1i("u_colorTexture",i+1),r.setUniform2fv("u_texSize",x),r.setUniform2fv("u_direction",e),l.setViewport(0,0,x[0],x[1]);const o=this._mipsFBOs[i];l.bindFramebuffer(o.horizontal),O.draw(),w=o.horizontal.colorTexture,l.bindFramebuffer(o.vertical),l.bindTexture(w,i+1),r.setUniform2fv("u_direction",s),O.draw(),w=o.vertical.colorTexture,x[0]=Math.round(x[0]/2),x[1]=Math.round(x[1]/2)}l.setViewport(0,0,f,g);const M=d.getProgram(t,_.composite,[{name:"nummips",value:5}]);l.bindFramebuffer(this._compositeFBO),l.bindProgram(M),M.setUniform1f("u_bloomStrength",b),M.setUniform1f("u_bloomRadius",F),M.setUniform1fv("u_bloomFactors",r),M.setUniform3fv("u_bloomTintColors",o),l.bindTexture(this._mipsFBOs[0].vertical.colorTexture,1),M.setUniform1i("u_blurTexture1",1),l.bindTexture(this._mipsFBOs[1].vertical.colorTexture,2),M.setUniform1i("u_blurTexture2",2),l.bindTexture(this._mipsFBOs[2].vertical.colorTexture,3),M.setUniform1i("u_blurTexture3",3),l.bindTexture(this._mipsFBOs[3].vertical.colorTexture,4),M.setUniform1i("u_blurTexture4",4),l.bindTexture(this._mipsFBOs[4].vertical.colorTexture,5),M.setUniform1i("u_blurTexture5",5),O.draw(),l.bindFramebuffer(n),l.setBlendingEnabled(!0);const v=d.getProgram(t,_.blit);l.bindProgram(v),l.bindTexture(this._compositeFBO.colorTexture,6),v.setUniform1i("u_texture",6),l.setBlendFunction(1,1),O.draw(),O.unbind(),l.setBlendFunction(1,771),l.setStencilTestEnabled(!0)}_createOrResizeResources(i){const{context:e,state:s,pixelRatio:r}=i,{size:o}=s,n=Math.round(r*o[0]),a=Math.round(r*o[1]);if(this._compositeFBO&&this._size[0]===n&&this._size[1]===a)return;this._size[0]=n,this._size[1]=a;const l=[Math.round(n/2),Math.round(a/2)];this._compositeFBO?this._compositeFBO.resize(n,a):this._compositeFBO=new t(e,{colorTarget:0,depthStencilTarget:0,width:n,height:a}),this._intensityFBO?this._intensityFBO.resize(l[0],l[1]):this._intensityFBO=new t(e,{colorTarget:0,depthStencilTarget:0,width:l[0],height:l[1]},{target:3553,pixelFormat:6408,internalFormat:6408,dataType:5121,wrapMode:33071,samplingMode:9729,flipped:!1,width:l[0],height:l[1]});for(let i=0;i<this._nMips;i++)this._mipsFBOs[i]?(this._mipsFBOs[i].horizontal.resize(l[0],l[1]),this._mipsFBOs[i].vertical.resize(l[0],l[1])):this._mipsFBOs[i]={horizontal:new t(e,{colorTarget:0,depthStencilTarget:0,width:l[0],height:l[1]},{target:3553,pixelFormat:6408,internalFormat:6408,dataType:5121,wrapMode:33071,samplingMode:9729,flipped:!1,width:l[0],height:l[1]}),vertical:new t(e,{colorTarget:0,depthStencilTarget:0,width:l[0],height:l[1]},{target:3553,pixelFormat:6408,internalFormat:6408,dataType:5121,wrapMode:33071,samplingMode:9729,flipped:!1,width:l[0],height:l[1]})},l[0]=Math.round(l[0]/2),l[1]=Math.round(l[1]/2)}}export{n as Bloom};
