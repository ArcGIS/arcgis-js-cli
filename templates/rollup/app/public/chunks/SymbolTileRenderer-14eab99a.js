import{aL as e,p as t,q as i,al as s}from"../main.js";import"./featureConversionUtils-0e5f7c52.js";import"./definitions-5e24d82a.js";import"./RenderingContext-81847018.js";import{I as r}from"./Utils-b46864a6.js";import{m as a}from"./CircularArray-e829d2b1.js";import"./visualVariablesUtils-a8352e1b.js";import"./earcut-69661edf.js";import"./Rect-31175b04.js";import"./GeometryUtils-2b0c8e16.js";import"./BidiEngine-b37d0381.js";import"./VertexArrayObject-17b5c9bd.js";import"./ShaderCompiler-2335fa5a.js";import"./Container-c6c95dc1.js";import"./mat4f32-a7ddfa75.js";import{g as l}from"./WGLContainer-720c8185.js";import"./MaterialKey-a89f5ca3.js";import{w as n}from"./shapingUtils-e86a3b68.js";import{l as o,D as h}from"./FeatureContainer-de88ad63.js";import"./VertexBuffer-06b50273.js";import"./TileContainer-59d09056.js";import"./MD5-f399cfb7.js";import{o as d}from"./BaseTileRenderer-896985d7.js";class u extends o{constructor(e,t,i){super(e),this._pointToCallbacks=new Map,this._layer=i,this._layerView=t}renderChildren(e){this.hasAnimation&&e.painter.effects.integrate.draw(e,e.attributeView),super.renderChildren(e)}hitTest(t,i){const s=[t,i],r=e();return this._pointToCallbacks.set(s,r),this.requestRender(),r.promise}doRender(e){const{minScale:t,maxScale:i}=this._layer,s=e.state.scale;s<=(t||1/0)&&s>=i&&super.doRender(e)}get hasAnimation(){return this.hasLabels}get hasLabels(){const e=this._layer.featureReduction,t=e&&"cluster"===e.type&&e.labelsVisible&&e.labelingInfo&&e.labelingInfo.length;return this._layer.labelingInfo&&this._layer.labelingInfo.length&&this._layer.labelsVisible||!!t}get labelsVisible(){return this._layer.labelsVisible}prepareRenderPasses(e){const t=e.registerRenderPass({name:"label",brushes:[l.label],target:()=>this.hasLabels?this.children:null,drawPhase:r.LABEL|r.LABEL_ALPHA}),i=e.registerRenderPass({name:"geometry",brushes:[l.fill,l.line,l.marker,l.text],target:()=>this.children,effects:[{apply:e.effects.highlight,enable:()=>!!this._layerView.hasHighlight()},{apply:e.effects.hittest,enable:()=>!!this._pointToCallbacks.size,args:()=>this._pointToCallbacks}]});return[...super.prepareRenderPasses(e),i,t]}}let p=class extends d{install(e){const t=new u(this.tileInfoView,this.layerView,this.layer);this.featuresView=t,e.addChild(t)}uninstall(e){e.removeChild(this.featuresView),this.featuresView.destroy()}hitTest(e,t){return this.featuresView.hitTest(e,t)}supportsRenderer(e){return null!=e&&-1!==["simple","class-breaks","unique-value","dot-density","dictionary"].indexOf(e.type)}onConfigUpdate(e){let t=null;if("visualVariables"in e){const i=(n(e).visualVariables||[]).map((e=>{const t=e.clone();return"normalizationField"in e&&(t.normalizationField=null),e.valueExpression&&"$view.scale"!==e.valueExpression&&(t.valueExpression=null,t.field="nop"),t}));t=a(i)}this.featuresView.setRendererInfo(e,t,this.layerView.effects)}onTileData(e){const t=this.tiles.get(e.tileKey);t&&this.featuresView.onTileData(t,e.data),this.layerView.view.labelManager.requestUpdate()}onTileError(e){const t=this.tiles.get(e.tileKey);t&&this.featuresView.onTileError(t)}forceAttributeTextureUpload(){this.featuresView.attributeView.forceTextureUpload()}lockGPUUploads(){this.featuresView.attributeView.lockTextureUpload(),this.tiles.forEach((e=>e.lockUploads()))}unlockGPUUploads(){this.featuresView.attributeView.unlockTextureUpload(),this.tiles.forEach((e=>e.unlockUploads()))}async getMaterialItems(e){return this.featuresView.getMaterialItems(e)}invalidateLabels(){this.featuresView.hasLabels&&(this.tiles.forEach((e=>e.isDirty=!0)),this.layerView.view.labelManager.requestUpdate())}createTile(e){const t=this.tileInfoView.getTileBounds(s(),e),i=new h(e,t);return this.featuresView.hasLabels&&this.layerView.view.labelManager.addTile(this.layerView,i),i}disposeTile(e){this.featuresView.removeChild(e),this.featuresView.hasLabels&&this.layerView.view.labelManager.removeTile(this.layerView,e.key.id),e.destroy(),this.layerView.view.labelManager.requestUpdate()}};p=t([i("esri.views.2d.layers.features.tileRenderers.SymbolTileRenderer")],p);var f=p;export default f;
