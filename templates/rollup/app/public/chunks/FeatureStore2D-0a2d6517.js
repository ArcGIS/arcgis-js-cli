import{i as e,aX as t,t as s,dW as a,x as i,v as r,bl as n,J as o,b0 as d}from"../main.js";import{i as c}from"./quantizationUtils-779d11a7.js";import{G as u}from"./aaBoundingBox-56c013d2.js";const h=import("./labelFormatUtils-e33bc498.js");class l{constructor(e,t){this._canCacheExpressionValue=!1,this._sourceInfo=e,this._bitsets={computed:t.getBitset(t.createBitset())}}async updateSchema(e,n){const o=t(this._schema,n);if(this._schema=n,!n||s(o)||!a(o,"attributes"))return;i("esri-2d-update-debug")&&console.debug("Applying Update - Store:",o),this._bitsets.computed.clear(),e.targets[n.name]=!0;const d=n.attributes,c=[],u=[];for(const e in d){const t=d[e];switch(t.type){case"field":break;case"expression":c.push(this._createArcadeComputedField(t));break;case"label-expression":c.push(this._createLabelArcadeComputedField(t));break;case"statistic":u.push(t)}}this._computedFields=await r(c),this._canCacheExpressionValue=!this._computedFields.some((e=>"expression"===e.type&&e.expression.referencesScale())),this._statisticFields=u}setComputedAttributes(e,t,s,a){const i=this._bitsets.computed;if(!this._canCacheExpressionValue||!i.has(s)){i.set(s);for(const i of this._computedFields){const r=this._evaluateField(t,i,a);switch(i.resultType){case"numeric":e.setComputedNumericAtIndex(s,i.fieldIndex,r);break;case"string":e.setComputedStringAtIndex(s,i.fieldIndex,r)}}}}async _createArcadeComputedField(e){const t=this._sourceInfo.spatialReference,s=this._sourceInfo.fieldsIndex;return{...e,expression:await n(e.valueExpression,t,s)}}async _createLabelArcadeComputedField(e){const t=this._sourceInfo.spatialReference,s=this._sourceInfo.fields,{createLabelFunction:a}=await h,i=await a(e.label,s,t);return{...e,builder:i}}_evaluateField(t,s,a){switch(s.type){case"label-expression":{const e=t.readArcadeFeature();return s.builder.evaluate(e)||""}case"expression":{const{expression:i}=s;return function(t,s,a){t.referencesGeometry();const i=s.readArcadeFeature();try{return t.evaluate({...a,$feature:i})}catch(t){return e.getLogger("esri.views.2d.support.arcadeOnDemand").warn("Feature arcade evaluation failed:",t),null}}(i,t,{$view:{scale:a}})}}}}function p(e){return(4294901760&e)>>>16}function I(e){return 65535&e}const _={getObjectId:e=>e.getObjectId(),getAttributes:e=>e.readAttributes(),getAttribute:(e,t)=>e.readAttribute(t),cloneWithGeometry:(e,t)=>e,getGeometry:e=>e.readHydratedGeometry(),getCentroid:(e,t)=>e.readCentroid()};class g extends l{constructor(e,t){super(e,t),this.featureAdapter=_,this.events=new o,this._featureSetsByInstance=new Map,this._objectIdToDisplayId=new Map,this._spatialIndexInvalid=!0,this._index=c(9,(e=>({minX:this._storage.getXMin(e),minY:this._storage.getYMin(e),maxX:this._storage.getXMax(e),maxY:this._storage.getYMax(e)})))}get storeStatistics(){return{featureCount:0,vertexCount:0}}onTileData(e,t,a){if(s(t.addOrUpdate))return t;this._featureSetsByInstance.set(t.addOrUpdate.instance,t.addOrUpdate),this._storage=a,t.addOrUpdate._storage=a;const i=t.addOrUpdate.getCursor();for(;i.next();){const t=i.getObjectId(),s=i.instance<<16|i.getIndex();let r=this._objectIdToDisplayId.get(t);r||(r=a.createDisplayId(),this._objectIdToDisplayId.set(t,r),this._spatialIndexInvalid=!0),i.setDisplayId(r),a.setInstanceId(r,s),this.setComputedAttributes(a,i,r,e.scale)}return"update"===t.type&&(this._spatialIndexInvalid=!0),this.events.emit("changed"),t}forEach(e){this._objectIdToDisplayId.forEach((t=>{const s=this._storage.getInstanceId(t),a=this._lookupFeature(s);e(a)}))}forEachUnsafe(e){this._objectIdToDisplayId.forEach((t=>{const s=this._storage.getInstanceId(t),a=p(s),i=I(s),r=this._getFeatureSet(a);r.setIndex(i),e(r)}))}forEachInBounds(e,t){const s=this._searchIndex(e);for(const e of s){const s=this.lookupFeatureByDisplayId(e,this._storage);t(d(s))}}forEachBounds(e,t,s){this._rebuildIndex();const a=[0,0,0,0];for(const i of e){const e=i.getDisplayId();a[0]=this._storage.getXMin(e),a[1]=this._storage.getYMin(e),a[2]=this._storage.getXMax(e),a[3]=this._storage.getYMax(e),t(u(s,a))}}sweepFeatures(e,t){this._objectIdToDisplayId.forEach(((s,a)=>{e.has(s)||(t.releaseDisplayId(s),this._objectIdToDisplayId.delete(a))})),this.events.emit("changed")}sweepFeatureSets(e){this._featureSetsByInstance.forEach(((t,s)=>{e.has(s)||this._featureSetsByInstance.delete(s)}))}lookupObjectId(e,t){const a=this.lookupFeatureByDisplayId(e,t);return s(a)?null:a.getObjectId()}lookupDisplayId(e){return this._objectIdToDisplayId.get(e)}lookupFeatureByDisplayId(e,t){const s=t.getInstanceId(e);return this._lookupFeature(s)}lookupByDisplayIdUnsafe(e){const t=this._storage.getInstanceId(e),s=p(t),a=I(t),i=this._getFeatureSet(s);return i?(i.setIndex(a),i):null}hasInstance(e){return this._featureSetsByInstance.has(e)}_rebuildIndex(){if(!this._spatialIndexInvalid)return;this._index.clear();const e=[];this._objectIdToDisplayId.forEach((t=>{const s=this._storage.getInstanceId(t);this._storage.setBounds(t,this._lookupFeature(s))&&e.push(t)})),this._index.load(e),this._spatialIndexInvalid=!1}_lookupFeature(e){const t=p(e),s=I(e),a=this._getFeatureSet(t);if(!a)return null;const i=a.getCursor();return i.setIndex(s),i}_getFeatureSet(e){return this._featureSetsByInstance.get(e)}_searchIndex(e){this._rebuildIndex();const t={minX:e[0],minY:e[1],maxX:e[2],maxY:e[3]};return this._index.search(t)}}export{_ as d,g as h,l as n};
