import{v as e,U as n,eI as t,cu as r}from"../main.js";import{P as i,B as a,K as s,$ as l,n as o,y as f,w as u,b as c,Z as d,Q as m,r as p,c as y,ag as g,ah as h,a2 as I,ai as E}from"./arcadeUtils-f665f7ae.js";import"./number-c01be8dd.js";import"./featureConversionUtils-0e5f7c52.js";import"./centroid-aa1305d6.js";import"./FeatureSetReader-b7349ae0.js";import{WhereClause as F}from"./WhereClause-5e802398.js";import"./MD5-f399cfb7.js";import"./geometryEngineAsync-bc28b6ac.js";import{I as D,O as w,b,y as A,_ as N,e as x,a as S,c as $,A as T,T as L,N as R,F as v,d as C,C as j,v as O,E as M,w as P}from"./featureSetUtils-54ce555d.js";import{y as k,E as G}from"./SpatialFilter-93c7e7d0.js";function B(t,r,i){const a=t.getVariables();if(a.length>0){const n=[];for(let e=0;e<a.length;e++){const t={name:a[e]};n.push(r.evaluateIdentifier(i,t))}return e(n).then((e=>{const n={};for(let t=0;t<a.length;t++)n[a[t]]=e[t];return t.parameters=n,t}))}return n(t)}function V(e,n,t=null){for(const t in e)if(t.toLowerCase()===n.toLowerCase())return e[t];return t}function H(e){if(null===e)return null;const n={type:V(e,"type",""),name:V(e,"name","")};if("range"===n.type)n.range=V(e,"range",[]);else{n.codedValues=[];for(const t of V(e,"codedValues",[]))n.codedValues.push({name:V(t,"name",""),code:V(t,"code",null)})}return n}function z(e){if(null===e)return null;const n={},t=V(e,"wkt",null);null!==t&&(n.wkt=t);const r=V(e,"wkid",null);return null!==r&&(n.wkid=r),n}function W(e){if(null===e)return null;const n={hasZ:V(e,"hasz",!1),hasM:V(e,"hasm",!1)},t=V(e,"spatialreference",null);t&&(n.spatialReference=z(t));const r=V(e,"x",null);if(null!==r)return n.x=r,n.y=V(e,"y",null),n;const i=V(e,"rings",null);if(null!==i)return n.rings=i,n;const a=V(e,"paths",null);if(null!==a)return n.paths=a,n;const s=V(e,"points",null);if(null!==s)return n.points=s,n;for(const t of["xmin","xmax","ymin","ymax","zmin","zmax","mmin","mmax"]){const r=V(e,t,null);null!==r&&(n[t]=r)}return n}function _(_){"async"===_.mode&&(_.functions.featuresetbyid=function(e,n){return _.standardFunctionAsync(e,n,((e,n,t)=>{if(i(t,2,4),t[0]instanceof D){const e=a(t[1]);let n=s(t[2],null);const r=l(s(t[3],!0));if(null===n&&(n=["*"]),!1===o(n))throw new Error("Invalid Parameter");return t[0].featureSetById(e,r,n)}throw new Error("Invalid Parameter")}))},_.signatures.push({name:"featuresetbyid",min:"2",max:"4"}),_.functions.featuresetbyportalitem=function(e,n){return _.standardFunctionAsync(e,n,((n,t,r)=>{if(i(r,2,5),null===r[0])throw new Error("Portal is required");if(r[0]instanceof f){const n=a(r[1]),t=a(r[2]);let i=s(r[3],null);const f=l(s(r[4],!0));if(null===i&&(i=["*"]),!1===o(i))throw new Error("Invalid Parameter");let u=null;return e.services&&e.services.portal&&(u=e.services.portal),u=w(r[0],u),b(n,t,e.spatialReference,i,f,u,e.lrucache)}if(!1===u(r[0]))throw new Error("Portal is required");const c=a(r[0]),d=a(r[1]);let m=s(r[2],null);const p=l(s(r[3],!0));if(null===m&&(m=["*"]),!1===o(m))throw new Error("Invalid Parameter");if(e.services&&e.services.portal)return b(c,d,e.spatialReference,m,p,e.services.portal,e.lrucache);throw new Error("Portal is required")}))},_.signatures.push({name:"featuresetbyportalitem",min:"2",max:"5"}),_.functions.featuresetbyname=function(e,n){return _.standardFunctionAsync(e,n,((e,n,t)=>{if(i(t,2,4),t[0]instanceof D){const e=a(t[1]);let n=s(t[2],null);const r=l(s(t[3],!0));if(null===n&&(n=["*"]),!1===o(n))throw new Error("Invalid Parameter");return t[0].featureSetByName(e,r,n)}throw new Error("Invalid Parameter")}))},_.signatures.push({name:"featuresetbyname",min:"2",max:"4"}),_.functions.featureset=function(e,n){return _.standardFunction(e,n,((n,t,r)=>{i(r,1,1);let a=r[0];const s={layerDefinition:{geometryType:"",objectIdField:"",typeIdField:"",fields:[]},featureSet:{geometryType:"",features:[]}};if(u(a))a=JSON.parse(a),void 0!==a.layerDefinition?(s.layerDefinition=a.layerDefinition,s.featureSet=a.featureSet,a.layerDefinition.spatialReference&&(s.layerDefinition.spatialReference=a.layerDefinition.spatialReference)):(s.featureSet.features=a.features,s.featureSet.geometryType=a.geometryType,s.layerDefinition.geometryType=s.featureSet.geometryType,s.layerDefinition.objectIdField=a.objectIdFieldName,s.layerDefinition.typeIdField=a.typeIdFieldName,s.layerDefinition.fields=a.fields,a.spatialReference&&(s.layerDefinition.spatialReference=a.spatialReference));else{if(!(r[0]instanceof c))throw new Error("Invalid Parameter");{a=JSON.parse(r[0].castToText());const e=V(a,"layerdefinition");if(null!==e){s.layerDefinition.geometryType=V(e,"geometrytype",""),s.featureSet.geometryType=s.layerDefinition.geometryType,s.layerDefinition.objectIdField=V(e,"objectidfield",""),s.layerDefinition.typeIdField=V(e,"typeidfield","");const n=V(e,"spatialreference",null);n&&(s.layerDefinition.spatialReference=z(n));for(const n of V(e,"fields",[])){const e={name:V(n,"name",""),alias:V(n,"alias",""),type:V(n,"type",""),nullable:V(n,"nullable",!0),editable:V(n,"editable",!0),length:V(n,"length",null),domain:H(V(n,"domain"))};s.layerDefinition.fields.push(e)}const t=V(a,"featureset",null);if(t){const e={};for(const n of s.layerDefinition.fields)e[n.name.toLowerCase()]=n.name;for(const n of V(t,"features",[])){const t={},r=V(n,"attributes",{});for(const n in r)t[e[n.toLowerCase()]]=r[n];s.featureSet.features.push({attributes:t,geometry:W(V(n,"geometry",null))})}}}else{s.layerDefinition.geometryType=V(a,"geometrytype",""),s.featureSet.geometryType=s.layerDefinition.geometryType,s.layerDefinition.objectIdField=V(a,"objectidfieldname",""),s.layerDefinition.typeIdField=V(a,"typeidfieldname","");const e=V(a,"spatialreference",null);e&&(s.layerDefinition.spatialReference=z(e));for(const e of V(a,"fields",[])){const n={name:V(e,"name",""),alias:V(e,"alias",""),type:V(e,"type",""),nullable:V(e,"nullable",!0),editable:V(e,"editable",!0),length:V(e,"length",null),domain:H(V(e,"domain"))};s.layerDefinition.fields.push(n)}const n={};for(const e of s.layerDefinition.fields)n[e.name.toLowerCase()]=e.name;for(const e of V(a,"features",[])){const t={},r=V(e,"attributes",{});for(const e in r)t[n[e.toLowerCase()]]=r[e];s.featureSet.features.push({attributes:t,geometry:W(V(e,"geometry",null))})}}}}if(0==(!!(l=s).layerDefinition&&!!l.featureSet&&!1!==function(e,n){for(const n of["","esriGeometryPoint","esriGeometryPolyline","esriGeometryPolygon","esriGeometryMultipoint","esriGeometryEnvelope"])if(n===e)return!0;return!1}(l.layerDefinition.geometryType)&&null!==l.layerDefinition.objectIdField&&""!==l.layerDefinition.objectIdField&&!1!==o(l.layerDefinition.fields)&&!1!==o(l.featureSet.features)))throw new Error("Invalid Parameter");var l;return A.create(s,e.spatialReference)}))},_.signatures.push({name:"featureset",min:"1",max:"1"}),_.functions.filter=function(t,r){return _.standardFunctionAsync(t,r,((r,a,s)=>(i(s,2,2),d(s[0])?s[0].load().then((r=>{const i=F.create(s[1],r.getFieldsIndex()),a=i.getVariables();if(a.length>0){const n=[];for(let e=0;e<a.length;e++){const r={name:a[e]};n.push(_.evaluateIdentifier(t,r))}return e(n).then((e=>{const n={};for(let t=0;t<a.length;t++)n[a[t]]=e[t];return i.parameters=n,new N({parentfeatureset:s[0],whereclause:i})}))}return n(new N({parentfeatureset:s[0],whereclause:i}))})):_.failDefferred("Filter cannot accept this parameter type"))))},_.signatures.push({name:"filter",min:"2",max:"2"}),_.functions.orderby=function(e,t){return _.standardFunctionAsync(e,t,((e,t,r)=>{if(i(r,2,2),d(r[0])){const e=new x(r[1]);return n(new S({parentfeatureset:r[0],orderbyclause:e}))}return _.failDefferred("Order cannot accept this parameter type")}))},_.signatures.push({name:"orderby",min:"2",max:"2"}),_.functions.top=function(e,t){return _.standardFunctionAsync(e,t,((e,t,r)=>(i(r,2,2),d(r[0])?n(new $({parentfeatureset:r[0],topnum:r[1]})):o(r[0])?m(r[1])>=r[0].length?r[0].slice(0):r[0].slice(0,m(r[1])):p(r[0])?m(r[1])>=r[0].length()?r[0].slice(0):r[0].slice(0,m(r[1])):_.failDefferred("Top cannot accept this parameter type"))))},_.signatures.push({name:"top",min:"2",max:"2"}),_.functions.first=function(e,t){return _.standardFunctionAsync(e,t,((e,t,r)=>(i(r,1,1),d(r[0])?r[0].first(e.abortSignal).then((e=>{if(null!==e){const n=y.createFromGraphicLikeObject(e.geometry,e.attributes,r[0]);n._underlyingGraphic=e,e=n}return e})):o(r[0])?0===r[0].length?n(null):n(r[0][0]):p(r[0])?0===r[0].length()?n(null):n(r[0].get(0)):null)))},_.signatures.push({name:"first",min:"1",max:"1"}),_.functions.attachments=function(e,n){return _.standardFunctionAsync(e,n,((n,r,a)=>{i(a,1,2);const s={minsize:-1,maxsize:-1,types:null};if(a.length>1)if(a[1]instanceof c){if(a[1].hasField("minsize")&&(s.minsize=m(a[1].field("minsize"))),a[1].hasField("maxsize")&&(s.maxsize=m(a[1].field("maxsize"))),a[1].hasField("types")){const e=g(a[1].field("types"),!1);e.length>0&&(s.types=e)}}else if(null!==a[1])throw new Error("Invalid Parameter");if(a[0]instanceof y){let n=a[0]._layer;return n instanceof t&&(n=T(n,e.spatialReference,["*"],!0,e.lrucache)),null===n||!1===d(n)?[]:n.load().then((()=>n.queryAttachments(a[0].field(n.objectIdField),s.minsize,s.maxsize,s.types)))}if(null===a[0])return[];throw new Error("Invalid Parameter")}))},_.signatures.push({name:"attachments",min:"1",max:"2"}),_.functions.featuresetbyrelationshipname=function(e,n){return _.standardFunctionAsync(e,n,((n,r,f)=>{i(f,2,4);const u=f[0],c=a(f[1]);let m=s(f[2],null);const p=l(s(f[3],!0));if(null===m&&(m=["*"]),!1===o(m))throw new Error("Invalid Parameter");if(null===f[0])return null;if(!(f[0]instanceof y))throw new Error("Invalid Parameter");let g=u._layer;return g instanceof t&&(g=T(g,e.spatialReference,["*"],!0,e.lrucache)),null===g||!1===d(g)?null:g.load().then((n=>{const t=n.relationshipMetaData().filter((e=>e.name===c));if(0===t.length)return null;if(void 0!==t[0].relationshipTableId&&null!==t[0].relationshipTableId&&t[0].relationshipTableId>-1)return L(n,t[0],u.field(n.objectIdField),n.spatialReference,m,p,e.lrucache);let r=n.serviceUrl();return r?(r="/"===r.charAt(r.length-1)?r+t[0].relatedTableId.toString():r+"/"+t[0].relatedTableId.toString(),R(r,n.spatialReference,m,p,e.lrucache).then((e=>e.load().then((()=>e.relationshipMetaData())).then((r=>{if(r=r.filter((e=>e.id===t[0].id)),!1===u.hasField(t[0].keyField)||null===u.field(t[0].keyField))return n.getFeatureByObjectId(u.field(n.objectIdField),[t[0].keyField]).then((n=>{if(n){const i=F.create(r[0].keyField+"= @id",e.getFieldsIndex());return i.parameters={id:n.attributes[t[0].keyField]},e.filter(i)}return new k({parentfeatureset:e})}));const i=F.create(r[0].keyField+"= @id",e.getFieldsIndex());return i.parameters={id:u.field(t[0].keyField)},e.filter(i)}))))):null}))}))},_.signatures.push({name:"featuresetbyrelationshipname",min:"2",max:"4"}),_.functions.featuresetbyassociation=function(e,n){return _.standardFunctionAsync(e,n,((n,l,o)=>{i(o,2,3);const f=o[0],c=a(s(o[1],"")).toLowerCase(),m=u(o[2])?a(o[2]):null;if(null===o[0])return null;if(!(o[0]instanceof y))throw new Error("Invalid Parameter");let p=f._layer;return p instanceof t&&(p=T(p,e.spatialReference,["*"],!0,e.lrucache)),null===p||!1===d(p)?null:p.load().then((()=>{const n=p.serviceUrl();return v(n,e.spatialReference)})).then((e=>{let n=null,t=null,i=!1;if(null!==m&&""!==m&&void 0!==m){for(const n of e.terminals)n.terminalName===m&&(t=n.terminalId);null===t&&(i=!0)}const a=e.associations.getFieldsIndex(),s=a.get("TOGLOBALID").name,l=a.get("FROMGLOBALID").name,o=a.get("TOTERMINALID").name,u=a.get("FROMTERMINALID").name,d=a.get("FROMNETWORKSOURCEID").name,y=a.get("TONETWORKSOURCEID").name,g=a.get("ASSOCIATIONTYPE").name,E=a.get("ISCONTENTVISIBLE").name,D=a.get("OBJECTID").name;for(const e of p.fields)if("global-id"===e.type){n=f.field(e.name);break}let w=null,b=new C(new r({name:"percentalong",alias:"percentalong",type:"double"}),F.create("0",e.associations.getFieldsIndex())),A=new C(new r({name:"side",alias:"side",type:"string"}),F.create("''",e.associations.getFieldsIndex()));const N="globalid",x="globalId",S={};for(const n in e.lkp)S[n]=e.lkp[n].sourceId;const $=new j(new r({name:"classname",alias:"classname",type:"string"}),null,S);let T="";switch(c){case"midspan":{T=`((${s}='${n}') OR ( ${l}='${n}')) AND (${g} IN (5))`,$.codefield=F.create(`CASE WHEN (${s}='${n}') THEN ${d} ELSE ${y} END`,e.associations.getFieldsIndex());const t=I(M.findField(e.associations.fields,l));t.name=N,t.alias=N,w=new C(t,F.create(`CASE WHEN (${l}='${n}') THEN ${s} ELSE ${l} END`,e.associations.getFieldsIndex())),b=e.unVersion>=4?new P(M.findField(e.associations.fields,a.get("PERCENTALONG").name)):new C(new r({name:"percentalong",alias:"percentalong",type:"double"}),F.create("0",e.associations.getFieldsIndex()));break}case"junctionedge":{T=`((${s}='${n}') OR ( ${l}='${n}')) AND (${g} IN (4,6))`,$.codefield=F.create(`CASE WHEN (${s}='${n}') THEN ${d} ELSE ${y} END`,e.associations.getFieldsIndex());const t=I(M.findField(e.associations.fields,l));t.name=N,t.alias=N,w=new C(t,F.create(`CASE WHEN (${l}='${n}') THEN ${s} ELSE ${l} END`,e.associations.getFieldsIndex())),A=new C(new r({name:"side",alias:"side",type:"string"}),F.create(`CASE WHEN (${g}=4) THEN 'from' ELSE 'to' END`,e.associations.getFieldsIndex()));break}case"connected":{let r=s+"='@T'",i=l+"='@T'";null!==t&&(r+=` AND ${o}=@A`,i+=` AND ${u}=@A`),T="(("+r+") OR ("+i+"))",T=h(T,"@T",n),r=h(r,"@T",n),null!==t&&(r=h(r,"@A",t.toString()),T=h(T,"@A",t.toString())),$.codefield=F.create("CASE WHEN "+r+` THEN ${d} ELSE ${y} END`,e.associations.getFieldsIndex());const a=I(M.findField(e.associations.fields,l));a.name=N,a.alias=N,w=new C(a,F.create("CASE WHEN "+r+` THEN ${l} ELSE ${s} END`,e.associations.getFieldsIndex()));break}case"container":T=`${s}='${n}' AND ${g} = 2`,null!==t&&(T+=` AND ${o} = `+t.toString()),$.codefield=d,T="( "+T+" )",w=new O(M.findField(e.associations.fields,l),N,N);case"content":T=`(${l}='${n}' AND ${g} = 2)`,null!==t&&(T+=` AND ${u} = `+t.toString()),$.codefield=y,T="( "+T+" )",w=new O(M.findField(e.associations.fields,s),N,N);break;case"structure":T=`(${s}='${n}' AND ${g} = 3)`,null!==t&&(T+=` AND ${o} = `+t.toString()),$.codefield=d,T="( "+T+" )",w=new O(M.findField(e.associations.fields,l),N,x);break;case"attached":T=`(${l}='${n}' AND ${g} = 3)`,null!==t&&(T+=` AND ${u} = `+t.toString()),$.codefield=y,T="( "+T+" )",w=new O(M.findField(e.associations.fields,s),N,x);break;default:throw new Error("Invalid Parameter")}return i&&(T="1 <> 1"),new M({parentfeatureset:e.associations,adaptedFields:[new P(M.findField(e.associations.fields,D)),new P(M.findField(e.associations.fields,E)),w,A,$,b],extraFilter:T?F.create(T,e.associations.getFieldsIndex()):null})}))}))},_.signatures.push({name:"featuresetbyassociation",min:"2",max:"6"}),_.functions.groupby=function(t,r){return _.standardFunctionAsync(t,r,((r,s,l)=>(i(l,3,3),d(l[0])?l[0].load().then((r=>{const i=[],s=[];let f=!1,d=[];if(u(l[1]))d.push(l[1]);else if(l[1]instanceof c)d.push(l[1]);else if(o(l[1]))d=l[1];else{if(!p(l[1]))return _.failDefferred("Illegal Value: GroupBy");d=l[1].toArray()}for(const e of d)if(u(e)){const n=F.create(a(e),r.getFieldsIndex()),t=!0===G(n)?a(e):"%%%%FIELDNAME";i.push({name:t,expression:n}),"%%%%FIELDNAME"===t&&(f=!0)}else{if(!(e instanceof c))return _.failDefferred("Illegal Value: GroupBy");{const n=e.hasField("name")?e.field("name"):"%%%%FIELDNAME",t=e.hasField("expression")?e.field("expression"):"";if("%%%%FIELDNAME"===n&&(f=!0),!n)return _.failDefferred("Illegal Value: GroupBy");i.push({name:n,expression:F.create(t||n,r.getFieldsIndex())})}}if(d=[],u(l[2]))d.push(l[2]);else if(o(l[2]))d=l[2];else if(p(l[2]))d=l[2].toArray();else{if(!(l[2]instanceof c))return _.failDefferred("Illegal Value: GroupBy");d.push(l[2])}for(const e of d){if(!(e instanceof c))return _.failDefferred("Illegal Value: GroupBy");{const n=e.hasField("name")?e.field("name"):"",t=e.hasField("statistic")?e.field("statistic"):"",i=e.hasField("expression")?e.field("expression"):"";if(!n||!t||!i)return _.failDefferred("Illegal Value: GroupBy");s.push({name:n,statistic:t.toLowerCase(),expression:F.create(i,r.getFieldsIndex())})}}if(f){const e={};for(const n of r.fields)e[n.name.toLowerCase()]=1;for(const n of i)"%%%%FIELDNAME"!==n.name&&(e[n.name.toLowerCase()]=1);for(const n of s)"%%%%FIELDNAME"!==n.name&&(e[n.name.toLowerCase()]=1);let n=0;for(const t of i)if("%%%%FIELDNAME"===t.name){for(;1===e["field_"+n.toString()];)n++;e["field_"+n.toString()]=1,t.name="FIELD_"+n.toString()}}const m=[];for(const e of i)m.push(B(e.expression,_,t));for(const e of s)m.push(B(e.expression,_,t));return m.length>0?e(m).then((()=>n(l[0].groupby(i,s)))):n(l[0].groupby(i,s))})):_.failDefferred("Illegal Value: GroupBy"))))},_.signatures.push({name:"groupby",min:"3",max:"3"}),_.functions.distinct=function(t,r){return _.standardFunctionAsync(t,r,((r,s,l)=>d(l[0])?(i(l,2,2),l[0].load().then((r=>{const i=[];let s=[];if(u(l[1]))s.push(l[1]);else if(l[1]instanceof c)s.push(l[1]);else if(o(l[1]))s=l[1];else{if(!p(l[1]))return _.failDefferred("Illegal Value: GroupBy");s=l[1].toArray()}let f=!1;for(const e of s)if(u(e)){const n=F.create(a(e),r.getFieldsIndex()),t=!0===G(n)?a(e):"%%%%FIELDNAME";i.push({name:t,expression:n}),"%%%%FIELDNAME"===t&&(f=!0)}else{if(!(e instanceof c))return _.failDefferred("Illegal Value: GroupBy");{const n=e.hasField("name")?e.field("name"):"%%%%FIELDNAME",t=e.hasField("expression")?e.field("expression"):"";if("%%%%FIELDNAME"===n&&(f=!0),!n)return _.failDefferred("Illegal Value: GroupBy");i.push({name:n,expression:F.create(t||n,r.getFieldsIndex())})}}if(f){const e={};for(const n of r.fields)e[n.name.toLowerCase()]=1;for(const n of i)"%%%%FIELDNAME"!==n.name&&(e[n.name.toLowerCase()]=1);let n=0;for(const t of i)if("%%%%FIELDNAME"===t.name){for(;1===e["field_"+n.toString()];)n++;e["field_"+n.toString()]=1,t.name="FIELD_"+n.toString()}}const d=[];for(const e of i)d.push(B(e.expression,_,t));return d.length>0?e(d).then((()=>n(l[0].groupby(i,[])))):n(l[0].groupby(i,[]))}))):function(e,n,t,r){if(1===r.length){if(o(r[0]))return E(e,r[0],-1);if(p(r[0]))return E(e,r[0].toArray(),-1)}return E(e,r,-1)}("distinct",0,0,l)))})}export{_ as registerFunctions};
