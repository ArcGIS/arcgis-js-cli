import{p as e,y as t,q as a,bo as r,k as i,U as s,i as o,d1 as n,T as p,aT as h}from"../main.js";import"./featureConversionUtils-0e5f7c52.js";import"./definitions-5e24d82a.js";import"./RenderingContext-81847018.js";import"./Utils-b46864a6.js";import"./earcut-69661edf.js";import"./GeometryUtils-2b0c8e16.js";import"./VertexArrayObject-17b5c9bd.js";import"./ShaderCompiler-2335fa5a.js";import"./Container-c6c95dc1.js";import"./mat4f32-a7ddfa75.js";import"./WGLContainer-720c8185.js";import"./MaterialKey-a89f5ca3.js";import{l as m,p as d}from"./LayerView2D-6e7585a5.js";import"./Bitmap-a30fe19d.js";import{t as l}from"./BitmapContainer-9f88d8f9.js";import{w as c}from"./ExportStrategy-2371daad.js";import{y as u}from"./ExportWMSImageParameters-41c73c1d.js";const y=o=>{let n=class extends o{async fetchPopupFeatures(e){const{layer:t}=this;if(!e)return r(new i("wmslayerview:fetchPopupFeatures","Nothing to fetch without area",{layer:t}));const{popupEnabled:a}=t;if(!a)return r(new i("wmslayerview:fetchPopupFeatures","popupEnabled should be true",{popupEnabled:a}));const o=this.createFetchPopupFeaturesQuery(e),{extent:n,width:p,height:h,x:m,y:d}=o;if(!(n&&p&&h))throw new i("wmslayerview:fetchPopupFeatures","WMSLayer does not support fetching features.",{extent:n,width:p,height:h});const l=t.fetchFeatureInfo(n,p,h,m,d);return l?l.then((e=>[e])):s([])}};return e([t()],n.prototype,"layer",void 0),n=e([a("esri.layers.mixins.WMSLayerView")],n),n},f=o.getLogger("esri.views.2d.layers.WMSLayerView2D");let g=class extends(y(n(m(d)))){initialize(){const{layer:e,view:t}=this;e.supportsSpatialReference(t.spatialReference)||this.addResolvingPromise(r(new i("layerview:spatial-reference-incompatible","The spatial references supported by this WMS layer are incompatible with the spatial reference of the view",{layer:e})))}hitTest(){return null}update(e){this.strategy.update(e).catch((e=>{p(e)||f.error(e)}))}attach(){const{layer:e,view:t}=this,{imageMaxHeight:a,imageMaxWidth:r}=e;this._bitmapContainer=new l,this.container.addChild(this._bitmapContainer),this.strategy=new c({container:this._bitmapContainer,fetchSource:this.fetchImage.bind(this),requestUpdate:this.requestUpdate.bind(this),imageMaxHeight:a,imageMaxWidth:r,imageRotationSupported:!1,imageNormalizationSupported:!1,hidpi:!1}),this._exportWMSImageParameters=new u({layer:e,view:t}),this.handles.add(this._exportWMSImageParameters.watch("version",(e=>{this._exportImageVersion!==e&&(this._exportImageVersion=e,this.requestUpdate())})),"wms")}detach(){this.handles.remove("wms"),this.strategy.destroy(),this._exportWMSImageParameters.layer=null,this._exportWMSImageParameters.destroy(),this._exportWMSImageParameters=null,this.container.removeChild(this._bitmapContainer),this._bitmapContainer.removeAllChildren()}moveStart(){}viewChange(){}moveEnd(){this.requestUpdate()}createFetchPopupFeaturesQuery(e){const{view:t}=this,a=this._bitmapContainer,{x:r,y:i}=e,{spatialReference:s}=t;let o=null,n=0,p=0;a.children.some((e=>{const{width:t,height:a,resolution:m,x:d,y:l}=e,c=d+m*t,u=l-m*a;return r>=d&&r<=c&&i<=l&&i>=u&&(o=new h({xmin:d,ymin:u,xmax:c,ymax:l,spatialReference:s}),n=t,p=a,!0)}));const m=o.width/n,d=Math.round((r-o.xmin)/m),l=Math.round((o.ymax-i)/m);return{extent:o,width:n,height:p,x:d,y:l}}async doRefresh(){this.requestUpdate()}isUpdating(){return this.strategy.updating||this.updateRequested}fetchImage(e,t,a,r){return this.layer.fetchImage(e,t,a,{timeExtent:this._exportWMSImageParameters.timeExtent,timestamp:this.refreshTimestamp,...r})}};e([t()],g.prototype,"strategy",void 0),e([t({dependsOn:["strategy.updating"]})],g.prototype,"updating",void 0),g=e([a("esri.views.2d.layers.WMSLayerView2D")],g);var w=g;export default w;
