import{aC as t,k as e,i,bj as s,j as r,bk as n,bl as o,v as a,b4 as l,bm as h,bn as c,a$ as f,a as u,t as m,b0 as d,ak as p,bb as y,R as _,S as g,b5 as x,V as M,G as b,D as w,bg as v,H as S,bd as C,bo as L,U as P,bp as k,aL as T,A as z,aJ as I,aK as O,aI as R,T as A,h as N,b6 as F,E as D}from"../main.js";import{m as G,K as X,t as V}from"./featureConversionUtils-0e5f7c52.js";import{U as B,v as H,q as W,k as E}from"./quantizationUtils-779d11a7.js";import{s as K,X as Y,i as Z,o as U,R as j,j as q,w as J,x as $}from"./definitions-5e24d82a.js";import{E as Q,w as tt,m as et,Z as it,_ as st,a as rt}from"./Utils-b46864a6.js";import{f as nt,i as ot}from"./CircularArray-e829d2b1.js";import{s as at,n as lt,r as ht,E as ct,a as ft,i as ut,u as mt,o as dt,b as pt,c as yt}from"./TurboLine-c366e7cd.js";import{h as _t,M as gt}from"./GeometryUtils-2b0c8e16.js";import{S as xt,c as Mt,T as bt,z as wt,y as vt,E as St,e as Ct,m as Lt}from"./MaterialKey-a89f5ca3.js";import{i as Pt,o as kt,y as Tt,p as zt,v as It,A as Ot,a as Rt,T as At,G as Nt,b as Ft,r as Dt,s as Gt,c as Xt,d as Vt,n as Bt,e as Ht,f as Wt,g as Et}from"./shapingUtils-e86a3b68.js";import{e as Kt,r as Yt,d as Zt,f as Ut}from"./VertexBuffer-06b50273.js";function jt(t,e,i){const s=t=>{let e=t.length;for(;e--;)if(-1===" /-,\n".indexOf(t.charAt(e)))return!1;return!0},r=[];let n=0,o=-1;do{if(o=e.indexOf("[",n),o>=n){if(o>n){const t=e.substr(n,o-n);r.push([t,null,s(t)])}if(n=o+1,o=e.indexOf("]",n),o>=n){if(o>n){const i=t[e.substr(n,o-n)];i&&r.push([null,i,!1])}n=o+1}}}while(-1!==o);if(n<e.length-1){const t=e.substr(n);r.push([t,null,s(t)])}return t=>{let e="",s=null;for(const i of r){const[r,n,o]=i;if(r)o?s=r:(s&&(e+=s,s=null),e+=r);else{const i=t.attributes[n];i&&(s&&(e+=s,s=null),e+=i)}}return qt(e,i)}}function qt(t,e){switch("string"!=typeof t&&(t=String(t)),e){case"LowerCase":return t.toLowerCase();case"Allcaps":return t.toUpperCase();default:return t}}function Jt(t,e,i,s,r,n,o=!0){const a=e/r,l=i/n,h=Math.ceil(a/2),c=Math.ceil(l/2);for(let i=0;i<n;i++)for(let f=0;f<r;f++){const u=4*(f+(o?n-i-1:i)*r);let m=0,d=0,p=0,y=0,_=0,g=0,x=0;const M=(i+.5)*l;for(let s=Math.floor(i*l);s<(i+1)*l;s++){const i=Math.abs(M-(s+.5))/c,r=(f+.5)*a,n=i*i;for(let i=Math.floor(f*a);i<(f+1)*a;i++){let o=Math.abs(r-(i+.5))/h;const a=Math.sqrt(n+o*o);a>=-1&&a<=1&&(m=2*a*a*a-3*a*a+1,m>0&&(o=4*(i+s*e),x+=m*t[o+3],p+=m,t[o+3]<255&&(m=m*t[o+3]/250),y+=m*t[o],_+=m*t[o+1],g+=m*t[o+2],d+=m))}}s[u]=y/d,s[u+1]=_/d,s[u+2]=g/d,s[u+3]=x/p}}function $t(t){return t?{r:t[0],g:t[1],b:t[2],a:t[3]/255}:{r:0,g:0,b:0,a:0}}function Qt(t){if(!t)return null;switch(t.type){case"CIMPointSymbol":{const e=t.symbolLayers;return e&&1===e.length?Qt(e[0]):null}case"CIMVectorMarker":{const e=t.markerGraphics;if(!e||1!==e.length)return null;const i=e[0];if(!i)return null;const s=i.geometry;if(!s)return null;const r=i.symbol;return!r||"CIMPolygonSymbol"!==r.type&&"CIMLineSymbol"!==r.type?null:{geom:s,asFill:"CIMPolygonSymbol"===r.type}}case"sdf":return{geom:t.geom,asFill:t.asFill}}return null}function te(t){let e=1/0,i=-1/0,s=1/0,r=-1/0;for(const n of t)for(const t of n)t[0]<e&&(e=t[0]),t[0]>i&&(i=t[0]),t[1]<s&&(s=t[1]),t[1]>r&&(r=t[1]);return[e,s,i,r]}function ee(e){return e?e.rings?te(e.rings):e.paths?te(e.paths):t(e)?[e.xmin,e.ymin,e.xmax,e.ymax]:null:null}function ie(t,e,i,s,r){const[n,o,a,l]=t;if(a<n||l<o)return[0,0,0];const h=a-n,c=l-o,f=Math.floor(31.5),u=(128-2*(f+1))/Math.max(h,c),m=Math.round(h*u)+2*f,d=Math.round(c*u)+2*f;let p=1;e&&(p=d/u/(e.ymax-e.ymin));let y=0,_=0;if(s)if(r){if(e&&i&&e.ymax-e.ymin>0){const t=(e.xmax-e.xmin)/(e.ymax-e.ymin);y=s.x/(i*t),_=s.y/i}}else y=s.x,_=s.y;return y=.5*(e.xmax+e.xmin)+y*(e.xmax-e.xmin),_=.5*(e.ymax+e.ymin)+_*(e.ymax-e.ymin),y-=n,_-=o,y*=u,_*=u,y+=f,_+=f,[p,y/m-.5,-(_/d-.5)]}function se(t){const e=(i=t.geom)?i.rings?i.rings:i.paths?i.paths:void 0!==i.xmin&&void 0!==i.ymin&&void 0!==i.xmax&&void 0!==i.ymax?[[[i.xmin,i.ymin],[i.xmin,i.ymax],[i.xmax,i.ymax],[i.xmax,i.ymin],[i.xmin,i.ymin]]]:null:null;var i;const s=function(t){let e=1/0,i=-1/0,s=1/0,r=-1/0;for(const n of t)for(const t of n)t[0]<e&&(e=t[0]),t[0]>i&&(i=t[0]),t[1]<s&&(s=t[1]),t[1]>r&&(r=t[1]);return new Pt(e,s,i-e,r-s)}(e),r=Math.floor(31.5),n=(128-2*(r+1))/Math.max(s.width,s.height),o=Math.round(s.width*n)+2*r,a=Math.round(s.height*n)+2*r,l=[];for(const i of e)if(i&&i.length>1){const e=[];for(const t of i){let[i,o]=t;i-=s.x,o-=s.y,i*=n,o*=n,i+=r-.5,o+=r-.5,e.push([i,o])}if(t.asFill){const t=e.length-1;e[0][0]===e[t][0]&&e[0][1]===e[t][1]||e.push(e[0])}l.push(e)}const h=function(t,e,i,s){const r=e*i,n=new Array(r),o=s*s+1;for(let t=0;t<r;++t)n[t]=o;for(const r of t){const t=r.length;for(let o=1;o<t;++o){const t=r[o-1],a=r[o];let l,h,c,f;t[0]<a[0]?(l=t[0],h=a[0]):(l=a[0],h=t[0]),t[1]<a[1]?(c=t[1],f=a[1]):(c=a[1],f=t[1]);let u=Math.floor(l)-s,m=Math.floor(h)+s,d=Math.floor(c)-s,p=Math.floor(f)+s;u<0&&(u=0),m>e&&(m=e),d<0&&(d=0),p>i&&(p=i);const y=a[0]-t[0],_=a[1]-t[1],g=y*y+_*_;for(let s=u;s<m;s++)for(let r=d;r<p;r++){let o,l,h=(s-t[0])*y+(r-t[1])*_;h<0?(o=t[0],l=t[1]):h>g?(o=a[0],l=a[1]):(h/=g,o=t[0]+h*y,l=t[1]+h*_);const c=(s-o)*(s-o)+(r-l)*(r-l),f=(i-r-1)*e+s;c<n[f]&&(n[f]=c)}}}for(let t=0;t<r;++t)n[t]=Math.sqrt(n[t]);return n}(l,o,a,r);return t.asFill&&function(t,e,i,s,r){for(const n of t){const t=n.length;for(let o=1;o<t;++o){const t=n[o-1],a=n[o];let l,h,c,f;t[0]<a[0]?(l=t[0],h=a[0]):(l=a[0],h=t[0]),t[1]<a[1]?(c=t[1],f=a[1]):(c=a[1],f=t[1]);let u=Math.floor(l),m=Math.floor(h)+1,d=Math.floor(c),p=Math.floor(f)+1;u<s&&(u=s),m>e-s&&(m=e-s),d<s&&(d=s),p>i-s&&(p=i-s);for(let n=d;n<p;++n){if(t[1]>n==a[1]>n)continue;const o=(i-n-1)*e;for(let e=u;e<m;++e)e<(a[0]-t[0])*(n-t[1])/(a[1]-t[1])+t[0]&&(r[o+e]=-r[o+e]);for(let t=s;t<u;++t)r[o+t]=-r[o+t]}}}}(l,o,a,r,h),[re(h,r),o,a]}function re(t,e){const i=2*e,s=t.length,r=new Uint8Array(4*s);for(let e=0;e<s;++e){const s=.5-t[e]/i;kt(s,r,4*e)}return r}function ne(t,i){if(t&&"name"in t){const s=t;return i&&i.error(new e(s.name,s.message,s.details)),!1}return!0}function oe(t,s,r,n,o){const a=t.referencesGeometry()&&o?function(t,s,r){const{transform:n,hasZ:o,hasM:a}=r;ae.has(s)||ae.set(s,function(t){const s={};switch(t){case"esriGeometryPoint":return(t,e,i,r)=>E(e,s,t,i,r);case"esriGeometryPolygon":return(t,e,i,r)=>W(e,s,t,i,r);case"esriGeometryPolyline":return(t,e,i,r)=>H(e,s,t,i,r);case"esriGeometryMultipoint":return(t,e,i,r)=>B(e,s,t,i,r);default:return i.getLogger("esri.views.2d.support.arcadeOnDemand").error(new e("mapview-arcade","Unable to handle geometryType: "+t)),t=>t}}(s));const l=ae.get(s)(t.geometry,n,o,a);return{...t,geometry:l}}(s,n,o):s,l=t.repurposeFeature(a);try{return t.evaluate({...r,$feature:l})}catch(t){return i.getLogger("esri.views.2d.support.arcadeOnDemand").warn("Feature arcade evaluation failed:",t),null}}const ae=new Map,le=i.getLogger("esri.symbols.cim.cimAnalyzer");function he(t){switch(t){case"Butt":return 0;case"Square":return 2;case"Round":default:return 1}}function ce(t){switch(t){case"Bevel":return 0;case"Miter":return 2;case"Round":default:return 1}}function fe(t){switch(t){case"Left":default:return"left";case"Right":return"right";case"Center":return"center";case"Justify":return"justify"}}function ue(t){switch(t){case"Top":default:return"top";case"Center":return"middle";case"Baseline":return"baseline";case"Bottom":return"bottom"}}function me(t,e,i,s){let r;t[e]?r=t[e]:(r={},t[e]=r),r[i]=s}function de(t){const e=t.markerPlacement;return e&&e.angleToLine?1:0}function pe(t,e,i,r,n){const o=t.primitiveName,a=$t(t.color),l=s(JSON.stringify(t)).toString();n.push({type:"fill",templateHash:l,materialHash:0===i.length?l:()=>l,cim:t,materialOverrides:null,colorLocked:t.colorLocked,color:ze(o,e,"Color",r,a,Te),height:0,angle:0,offsetX:0,offsetY:0,scaleX:1,effects:t.effects})}function ye(t,e,i,r,n){const o=t.primitiveName,a=t.tintColor?$t(t.tintColor):{r:255,g:255,b:255,a:1},l=s(JSON.stringify(t)).toString(),h=s(`${t.url}${JSON.stringify(t.colorSubstitutions)}`).toString();n.push({type:"fill",templateHash:l,materialHash:0===i.length?h:()=>h,cim:t,materialOverrides:null,colorLocked:t.colorLocked,effects:t.effects,color:ze(o,e,"TintColor",r,a,Te),height:ze(o,e,"Height",r,t.height),scaleX:ze(o,e,"ScaleX",r,t.scaleX),angle:ze(o,e,"Rotation",r,t.rotation),offsetX:ze(o,e,"OffsetX",r,t.offsetX),offsetY:ze(o,e,"OffsetY",r,t.offsetY)})}function _e(t,e,i,r,n){const o=["Rotation","OffsetX","OffsetY"],a=i.filter((e=>e.primitiveName!==t.primitiveName&&-1===o.indexOf(e.propertyName))),l=t.primitiveName,h=s(JSON.stringify(t)).toString(),c=s(`${t.separation}${JSON.stringify(t.lineSymbol)}`).toString();n.push({type:"fill",templateHash:h,materialHash:0===i.length?c:Ie(c,e,a,r),cim:t,materialOverrides:a,colorLocked:t.colorLocked,effects:t.effects,color:{r:255,g:255,b:255,a:1},height:ze(l,e,"Separation",r,t.separation),scaleX:1,angle:ze(l,e,"Rotation",r,t.rotation),offsetX:ze(l,e,"OffsetX",r,t.offsetX),offsetY:ze(l,e,"OffsetY",r,t.offsetY)})}function ge(t,e,i,r,n){const o=s(JSON.stringify(t)).toString();n.push({type:"fill",templateHash:o,materialHash:0===i.length?o:Ie(o,e,i,r),cim:t,materialOverrides:null,colorLocked:t.colorLocked,effects:t.effects,color:{r:128,g:128,b:128,a:1},height:0,angle:0,offsetX:0,offsetY:0,scaleX:1})}function xe(t,e,i,r,n,o,a){const l=s(JSON.stringify(t)).toString(),h=t.primitiveName,c=$t(t.color),f=void 0!==t.width?t.width:4,u=he(t.capStyle),m=ce(t.joinStyle),d=t.miterLimit;n.push({type:"line",templateHash:l,materialHash:0===i.length?l:()=>l,cim:t,materialOverrides:null,isOutline:o,colorLocked:t.colorLocked,effects:t.effects,color:ze(h,e,"Color",r,c,Te),width:ze(h,e,"Width",r,f),cap:ze(h,e,"CapStyle",r,u),join:ze(h,e,"JoinStyle",r,m),miterLimit:ze(h,e,"MiterLimit",r,d),referenceWidth:a,zOrder:ke(t.name),isDashed:!1})}function Me(t,e,i,r,n,o,a){const l=s(`${t.url}${JSON.stringify(t.colorSubstitutions)}`).toString(),h=t.primitiveName,c=$t(t.tintColor),f=void 0!==t.width?t.width:4,u=he(t.capStyle),m=ce(t.joinStyle),d=t.miterLimit,p=s(JSON.stringify(t)).toString();n.push({type:"line",templateHash:p,materialHash:0===i.length?l:()=>l,cim:t,materialOverrides:null,isOutline:o,colorLocked:t.colorLocked,effects:t.effects,color:ze(h,e,"TintColor",r,c,Te),width:ze(h,e,"Width",r,f),cap:ze(h,e,"CapStyle",r,u),join:ze(h,e,"JoinStyle",r,m),miterLimit:ze(h,e,"MiterLimit",r,d),referenceWidth:a,zOrder:ke(t.name),isDashed:!1})}function be(t,e,i,r,n,o,a){const l=t.primitiveName,h=void 0!==t.width?t.width:4,c=he(t.capStyle),f=ce(t.joinStyle),u=t.miterLimit,m=s(JSON.stringify(t)).toString();n.push({type:"line",templateHash:m,materialHash:0===i.length?m:Ie(m,e,i,r),cim:t,materialOverrides:null,isOutline:o,colorLocked:t.colorLocked,effects:t.effects,color:{r:128,g:128,b:128,a:1},width:ze(l,e,"Width",r,h),cap:ze(l,e,"CapStyle",r,c),join:ze(l,e,"JoinStyle",r,f),miterLimit:ze(l,e,"MiterLimit",r,u),referenceWidth:a,zOrder:ke(t.name),isDashed:!1})}function we(t,e,i,r,n){const o=t.markerPlacement;if(!o||"CIMMarkerPlacementInsidePolygon"!==o.type)return!1;const a=o,l=["Rotation","OffsetX","OffsetY"],h=i.filter((e=>e.primitiveName!==t.primitiveName&&-1===l.indexOf(e.propertyName))),c=s(JSON.stringify(t)).toString();return n.push({type:"fill",templateHash:c,materialHash:0===i.length?c:Ie(c,e,h,r),cim:t,materialOverrides:h,colorLocked:t.colorLocked,effects:t.effects,color:{r:255,g:255,b:255,a:1},height:ze(a.primitiveName,e,"StepY",r,a.stepY),scaleX:1,angle:ze(a.primitiveName,e,"GridAngle",r,a.gridAngle),offsetX:ze(a.primitiveName,e,"OffsetX",r,a.offsetX),offsetY:ze(a.primitiveName,e,"OffsetY",r,a.offsetY)}),!0}function ve(t,e,i,r,n,o,a){const l=t.primitiveName,h=t.size,c=t.scaleX,f=t.rotation,u=t.offsetX,m=t.offsetY,d=$t(t.tintColor),p=s(`${t.url}${JSON.stringify(t.colorSubstitutions)}`).toString();let y=!1,_="";for(const t of i)t.primitiveName===l&&(void 0!==t.value?_+=`-${t.primitiveName}-${t.propertyName}-${JSON.stringify(t.value)}`:t.valueExpressionInfo&&(y=!0));n.push({type:"marker",templateHash:s(JSON.stringify(t)+_).toString(),materialHash:y?()=>p:p,cim:t,materialOverrides:null,colorLocked:t.colorLocked,effects:t.effects,scaleSymbolsProportionally:!1,alignment:o,size:ze(l,e,"Size",r,h),scaleX:ze(l,e,"ScaleX",r,c),rotation:ze(l,e,"Rotation",r,f),offsetX:ze(l,e,"OffsetX",r,u),offsetY:ze(l,e,"OffsetY",r,m),color:ze(l,e,"TintColor",r,d,Te),anchorPoint:t.anchorPoint,isAbsoluteAnchorPoint:"Relative"!==t.anchorPointUnits,outlineColor:{r:0,g:0,b:0,a:0},outlineWidth:0,frameHeight:0,rotateClockwise:t.rotateClockwise,referenceSize:a,sizeRatio:1,markerPlacement:t.markerPlacement})}function Se(t,e,i,s,r,n,o,a){const l=t.markerGraphics;if(!l)return;let h=0;if(t.scaleSymbolsProportionally){const e=t.frame;e&&(h=e.ymax-e.ymin)}for(const c of l)if(c){const l=c.symbol;if(!l)continue;switch(l.type){case"CIMPointSymbol":case"CIMLineSymbol":case"CIMPolygonSymbol":Le(t,c,i,e,s,r,n,o,h,a);break;case"CIMTextSymbol":Ce(t,c,e,i,s,r,n,o,h)}}}function Ce(t,e,i,r,n,o,a,l,h){zt.findApplicableOverrides(e,r,[]);const c=e.geometry;if(!("x"in c)||!("y"in c))return;const f=e.symbol,u=(m=f).underline?"underline":m.strikethrough?"line-through":"none";var m;const d=function(t){let e="normal",i="normal";if(t){const s=t.toLowerCase();-1!==s.indexOf("italic")?e="italic":-1!==s.indexOf("oblique")&&(e="oblique"),-1!==s.indexOf("bold")?i="bold":-1!==s.indexOf("light")&&(i="lighter")}return{style:e,weight:i}}(f.fontStyleName);f.font={family:f.fontFamilyName,decoration:u,...d};const p=t.frame,y=c.x-.5*(p.xmin+p.xmax),_=c.y-.5*(p.ymin+p.ymax),g=t.size/h,x=t.primitiveName,M=(f.height||0)*g,b=f.angle||0,w=((f.offsetX||0)+y)*g,v=((f.offsetY||0)+_)*g,S=$t(Tt.getFillColor(f));let C=$t(Tt.getStrokeColor(f)),L=Tt.getStrokeWidth(f);L||(C=$t(Tt.getFillColor(f.haloSymbol)),L=f.haloSize*g);let P="";for(const t of r)t.primitiveName===x&&void 0!==t.value&&(P+=`-${t.primitiveName}-${t.propertyName}-${JSON.stringify(t.value)}`);const k=JSON.stringify(t.effects)+Number(t.colorLocked)+JSON.stringify(t.anchorPoint)+t.anchorPointUnits+JSON.stringify(t.markerPlacement),T=s(JSON.stringify(e)+k+P).toString();o.push({type:"text",templateHash:T,materialHash:()=>s(JSON.stringify(f.font)).toString(),cim:f,materialOverrides:null,colorLocked:t.colorLocked,effects:t.effects,alignment:a,anchorPoint:{x:t.anchorPoint?t.anchorPoint.x:0,y:t.anchorPoint?t.anchorPoint.y:0},isAbsoluteAnchorPoint:"Relative"!==t.anchorPointUnits,fontName:f.fontFamilyName,decoration:"none",weight:"normal",style:"normal",size:ze(x,i,"Size",n,M),angle:ze(x,i,"Rotation",n,b),offsetX:ze(x,i,"OffsetX",n,w),offsetY:ze(x,i,"OffsetY",n,v),horizontalAlignment:fe(f.horizontalAlignment),verticalAlignment:ue(f.verticalAlignment),text:ze(e.primitiveName,i,"TextString",n,e.textString,qt,f.textCase),color:S,outlineColor:C,outlineSize:L,referenceSize:l,sizeRatio:1,markerPlacement:t.markerPlacement})}function Le(t,e,i,r,n,o,a,l,h,c){const f=e.symbol,u=e.geometry;if(!u)return;const m=f.symbolLayers;if(!m)return;if(c)return void Pe(t,e,r,i,n,o,a,l,h);let d=m.length;for(;d--;){const c=m[d];if(c&&!1!==c.enable)switch(c.type){case"CIMSolidFill":case"CIMSolidStroke":{const f=ee(u);if(!f)continue;const[m,d,p]=ie(f,t.frame,t.size,t.anchorPoint,"Relative"!==t.anchorPointUnits),y="CIMSolidFill"===c.type,_={type:"sdf",geom:u,asFill:y},g=t.primitiveName,x=t.size,M=t.rotation||0,b=t.offsetX,w=t.offsetY,v=c.primitiveName,S=$t(y?Tt.getFillColor(c):Tt.getStrokeColor(c)),C=y?{r:0,g:0,b:0,a:0}:$t(Tt.getStrokeColor(c)),L=Tt.getStrokeWidth(c);if(!y&&!L)break;let P=!1,k="";for(const t of i)t.primitiveName!==v&&t.primitiveName!==g||(void 0!==t.value?k+=`-${t.primitiveName}-${t.propertyName}-${JSON.stringify(t.value)}`:t.valueExpressionInfo&&(P=!0));const T=JSON.stringify({...t,markerGraphics:null}),z=s(JSON.stringify(_)).toString(),I={type:"marker",templateHash:s(JSON.stringify(e)+JSON.stringify(c)+T+k).toString(),materialHash:P?()=>z:z,cim:_,materialOverrides:null,colorLocked:t.colorLocked,effects:t.effects,scaleSymbolsProportionally:t.scaleSymbolsProportionally,alignment:a,anchorPoint:{x:d,y:p},isAbsoluteAnchorPoint:!1,size:ze(t.primitiveName,r,"Size",n,x),rotation:ze(t.primitiveName,r,"Rotation",n,M),offsetX:ze(t.primitiveName,r,"OffsetX",n,b),offsetY:ze(t.primitiveName,r,"OffsetY",n,w),scaleX:1,frameHeight:h,rotateClockwise:t.rotateClockwise,referenceSize:l,sizeRatio:m,color:ze(v,r,"Color",n,S,Te),outlineColor:ze(v,r,"Color",n,C,Te),outlineWidth:ze(v,r,"Width",n,L),markerPlacement:t.markerPlacement};o.push(I);break}default:Pe(t,e,r,i,n,o,a,l,h)}}}function Pe(t,e,i,n,o,a,l,h,c){const f=function(t,e){return{type:t.type,enable:!0,name:t.name,colorLocked:t.colorLocked,primitiveName:t.primitiveName,anchorPoint:t.anchorPoint,anchorPointUnits:t.anchorPointUnits,offsetX:0,offsetY:0,rotateClockwise:t.rotateClockwise,rotation:0,size:t.size,billboardMode3D:t.billboardMode3D,depth3D:t.depth3D,frame:t.frame,markerGraphics:[e],scaleSymbolsProportionally:t.scaleSymbolsProportionally,respectFrame:t.respectFrame,clippingPath:t.clippingPath,effects:t.effects}}(t,e);let u=[];const m=["Rotation","OffsetX","OffsetY"];u=n.filter((e=>e.primitiveName!==t.primitiveName||-1===m.indexOf(e.propertyName)));let d="";for(const t of n)void 0!==t.value&&(d+=`-${t.primitiveName}-${t.propertyName}-${JSON.stringify(t.value)}`);const[p,y,_]=Tt.getTextureAnchor(f),g=t.primitiveName,x=t.rotation||0,M=t.offsetX||0,b=t.offsetY||0,w=s(JSON.stringify(f)+d).toString(),v={type:"marker",templateHash:w,materialHash:0===u.length?w:Ie(w,i,u,o),cim:f,materialOverrides:u,colorLocked:t.colorLocked,effects:t.effects,scaleSymbolsProportionally:t.scaleSymbolsProportionally,alignment:l,anchorPoint:{x:p,y:y},isAbsoluteAnchorPoint:!1,size:t.size,rotation:ze(g,i,"Rotation",o,x),offsetX:ze(g,i,"OffsetX",o,M),offsetY:ze(g,i,"OffsetY",o,b),color:{r:0,g:0,b:0,a:0},outlineColor:{r:0,g:0,b:0,a:0},outlineWidth:0,scaleX:1,frameHeight:c,rotateClockwise:t.rotateClockwise,referenceSize:h,sizeRatio:_/r(t.size),markerPlacement:t.markerPlacement};a.push(v)}function ke(t){if(t&&0===t.indexOf("Level_")){const e=parseInt(t.substr(6),10);if(NaN!==e)return e}return 0}function Te(t){if(!t||0===t.length)return null;const e=new l(t).toRgba();return{r:e[0],g:e[1],b:e[2],a:e[3]}}function ze(t,e,i,s,r,o,a){const l=e[t];if(l){const t=l[i];if("string"==typeof t||"number"==typeof t||t instanceof Array)return o?o.call(null,t,a):t;if(null!=t&&t instanceof n)return(e,i,n)=>{let l=oe(t,e,{$view:n},s.geometryType,i);return null!==l&&o&&(l=o.call(null,l,a)),null!==l?l:r}}return r}function Ie(t,e,i,r){for(const t of i)if(t.valueExpressionInfo){const i=e[t.primitiveName]&&e[t.primitiveName][t.propertyName];i instanceof n&&(t.fn=(t,e,s)=>oe(i,t,{$view:s},r.geometryType,e))}return(e,r,n)=>{for(const t of i)t.fn&&(t.value=t.fn(e,r,n));return s(t+zt.buildOverrideKey(i)).toString()}}const Oe={marker:Q.MARKER,fill:Q.FILL,line:Q.LINE,text:Q.TEXT};class Re{constructor(t,e,i){this.layers=t,this.data=e,this.hash=this._createHash(),this.rendererKey=i;for(const e of t){const t=Oe[e.type];e.materialKey=xt(t,this.rendererKey,!1,!1)}}get type(){return"expanded-cim"}_createHash(){let t="";for(const e of this.layers)t+=e.templateHash;return t}}const Ae=async(t,e)=>new Re(await async function(t,e,i,s){const r=i||[];if(!t)return r;let n,l;const h={};if("CIMSymbolReference"!==t.type)return le.error("Expect cim type to be 'CIMSymbolReference'"),r;if(n=t.symbol,l=t.primitiveOverrides,l){const t=[];for(const i of l){const s=i.valueExpressionInfo;if(s&&e){const r=s.expression,n=o(r,e.spatialReference,e.fields).then((t=>{t&&me(h,i.primitiveName,i.propertyName,t)}));t.push(n)}else null!=i.value&&me(h,i.primitiveName,i.propertyName,i.value)}await a(t)}switch(n.type){case"CIMPointSymbol":case"CIMLineSymbol":case"CIMPolygonSymbol":!function(t,e,i,s,r,n){if(!t)return;const o=t.symbolLayers;if(!o)return;let a;const l=Tt.getSize(t);"CIMPointSymbol"===t.type&&"Map"===t.angleAlignment&&(a=1);let h=o.length;for(;h--;){const c=o[h];if(!c||!1===c.enable)continue;const f=[];switch(zt.findApplicableOverrides(c,e,f),c.type){case"CIMSolidFill":pe(c,i,f,s,r);break;case"CIMPictureFill":ye(c,i,f,s,r);break;case"CIMHatchFill":_e(c,i,f,s,r);break;case"CIMGradientFill":ge(c,i,f,s,r);break;case"CIMSolidStroke":xe(c,i,f,s,r,"CIMPolygonSymbol"===t.type,l);break;case"CIMPictureStroke":Me(c,i,f,s,r,"CIMPolygonSymbol"===t.type,l);break;case"CIMGradientStroke":be(c,i,f,s,r,"CIMPolygonSymbol"===t.type,l);break;case"CIMCharacterMarker":if(we(c,i,f,s,r))break;break;case"CIMPictureMarker":if(we(c,i,f,s,r))break;"CIMLineSymbol"===t.type&&(a=de(c)),ve(c,i,f,s,r,a,l);break;case"CIMVectorMarker":if(we(c,i,f,s,r))break;"CIMLineSymbol"===t.type&&(a=de(c)),Se(c,i,f,s,r,a,l,n);break;default:le.error("Cannot analyze CIM layer",c.type)}}}(n,l,h,e,r,s)}return r}(t.data,e),t.data,t.rendererKey),Ne=async(t,e,i)=>{if(!t)return null;if("cim"===t.type)return Ae(t,e);if("web-style"===t.type){const s=h.fromJSON(t),r={type:"cim",data:(await s.fetchCIMSymbol(i)).data,rendererKey:t.rendererKey};return Ae(r,e)}return t},Fe=i.getLogger("esri/views/2d/engine/webgl/util/Matcher");class De{constructor(){this.type="feature",this._defaultResult=null}static async fromBasicRenderer(t,e,i){const s=new De;if(t.symbol){const r=await Ne(t.symbol,i),n=e.createTemplateGroup(r,null);s.setDefault(n)}return s}size(){return 1}getDefault(){return this._defaultResult}setDefault(t){this._defaultResult=t}match(t,e,i,s,r){return this.getDefault()}async analyze(t,e,i,s,r){return null}}class Ge extends De{constructor(t,e,i,s){super(),this.type="interval",this._intervals=[],this._isMaxInclusive=e,this._fieldIndex=s,this._field=t,this._normalizationInfo=i}static async fromCBRenderer(t,e,i){const{isMaxInclusive:s,normalizationField:r,normalizationTotal:n,normalizationType:o}=t,l=t.field,h=new Ge(l,s,{normalizationField:r,normalizationTotal:n,normalizationType:o},t.fieldIndex),c=await Ne(t.backgroundFillSymbol,i);await a(t.intervals.map((async t=>{const s=await Ne(t.symbol,i),r=await e.createTemplateGroup(s,c),n={min:t.min,max:t.max};h.add(n,r)})));const f=await Ne(t.defaultSymbol,i);if(f){const t=await e.createTemplateGroup(f,c);h.setDefault(t)}return h}add(t,e){this._intervals.push({interval:t,result:e}),this._intervals.sort(((t,e)=>t.interval.min-e.interval.min))}size(){return super.size()+this._intervals.length}match(t,e,i,s,r){if(null==this._fieldIndex&&!this._field)return this.getDefault();const n=null!=this._fieldIndex?e.getComputedNumericAtIndex(this._fieldIndex):this._getValueFromField(e);if(!n&&(null==n||isNaN(n)))return this.getDefault();for(let t=0;t<this._intervals.length;t++){const{interval:e,result:i}=this._intervals[t],s=n>=e.min,r=this._isMaxInclusive?n<=e.max:n<e.max;if(s&&r)return i}return this.getDefault()}_needsNormalization(){const t=this._normalizationInfo;return t&&(t.normalizationField||t.normalizationTotal||t.normalizationType)}_getValueFromField(t){const e=t.readAttribute(this._field);if(!this._needsNormalization())return e;const{normalizationField:i,normalizationTotal:s,normalizationType:r}=this._normalizationInfo,n=!!i&&t.readAttribute(i);if(r)switch(r){case"esriNormalizeByField":return n?e/n:void 0;case"esriNormalizeByLog":return Math.log(e)*Math.LOG10E;case"esriNormalizeByPercentOfTotal":return e/s*100;default:return void Fe.error("Found unknown normalization type: "+r)}else Fe.error("Normalization is required, but no type was set!")}}class Xe extends De{constructor(t,e,i){super(),this.type="map",this._nullResult=null,this._resultsMap=new Map,this._fieldsIndex=i,this._fields=t,this._seperator=e||""}static async fromUVRenderer(t,e,i){const s=t.fieldDelimiter,r=[t.field];t.field2&&r.push(t.field2),t.field3&&r.push(t.field3);const n=await Ne(t.backgroundFillSymbol,i),o=new Xe(r,s,t.fieldIndex);await a(t.map.map((async t=>{const s=await Ne(t.symbol,i),r=await e.createTemplateGroup(s,n);"<Null>"===t.value?o.setNullResult(r):o.add(t.value,r)})));const l=await Ne(t.defaultSymbol,i);if(l){const t=await e.createTemplateGroup(l,n);o.setDefault(t)}return o}setNullResult(t){this._nullResult=t}add(t,e){this._resultsMap.set(t.toString(),e)}size(){return super.size()+this._resultsMap.size}match(t,e,i,s,r){if(null==this._fieldsIndex&&!this._fields)return this.getDefault();const n=null!=this._fieldsIndex?e.getComputedStringAtIndex(this._fieldsIndex):this._getValueFromFields(e);if(null!==this._nullResult&&(null==n||""===n||"<Null>"===n))return this._nullResult;if(!n&&null==n)return this.getDefault();const o=n.toString();return this._resultsMap.has(o)?this._resultsMap.get(o):this.getDefault()}_getValueFromFields(t){const e=[];for(const i of this._fields){const s=t.readAttribute(i);e.push(s)}return e.join(this._seperator)}}class Ve extends De{constructor(t,e,i,s){super(),this.type="dictionary",this._groupIdCache=new c(100),this._renderer=t,this._fieldMap=t.fieldMap,this._symbolFields=t.getSymbolFields(),this._templates=e,this._info=i,this._scaleFn=s}static async fromDictionaryRenderer(t,e,i){const s=(await import("../main.js").then((function(t){return t.hj}))).default.fromJSON(t.renderer);await s.fetchResources({spatialReference:i.spatialReference,fields:i.fields});const r=await async function(t,e){const i=t||1;if("number"==typeof i)return(t,e,s)=>i;const s=await o(i,e.spatialReference,e.fields);return(t,i,r)=>oe(s,t,{$view:r},e.geometryType,i)||1}(s.scaleExpression,i);return new Ve(s,e,i,r)}async _analyzeFeature(t,i,s,r){const n=t.readLegacyFeature(),o=this._scaleFn(n,i,s),a=this._attributeHash(n)+"-"+o,l=this._groupIdCache.get(a);if(l)return l;const h={...s,spatialReference:this._info.spatialReference,abortOptions:r,fields:this._info.fields},c=await this._renderer.getSymbolAsync(n,h),f=It(c,this._renderer),u=Ne(f,this._info,r).then((t=>{if("expanded-cim"!==t.type)return Fe.error(new e("mapview-bad-type",`Found unexpected type ${t.type} in dictionary response`)),null;t.hash+="-"+o;for(const e of t.layers)e.scaleFactor=o,e.templateHash+="-"+o,"text"===e.type&&"string"==typeof e.text&&e.text.indexOf("[")>-1&&(e.text=jt(this._fieldMap,e.text,e.cim.textCase));return this._templates.createTemplateGroup(t,null)}));return this._groupIdCache.put(a,u,1),u}async analyze(t,e,i,s,r){const n=e.getCursor(),o=[];for(;n.next();)o.push(this._analyzeFeature(n,i,s,r));return a(o)}match(t,e,i,s,r){return null}_attributeHash(t){let e="";for(const i of this._symbolFields){const s=this._fieldMap[i];s&&(e+=t.attributes[s]+"-")}return e}}const Be=i.getLogger("esri/views/2d/engine/webgl/mesh/factories/matcherUtils");async function He(t,i,s){switch(t.type){case"simple":return De.fromBasicRenderer(t,i,s);case"map":return Xe.fromUVRenderer(t,i,s);case"interval":return Ge.fromCBRenderer(t,i,s);case"dictionary":return Ve.fromDictionaryRenderer(t,i,s);default:return Be.error(new e("mapview-mesh:invalid-renderer","Unable to handle unknown renderer type")),null}}class We{static getPlacement(t,e,i){const s=Ot(e);if(!s)return null;const r=Rt(t);return s.execute(r,e,i)}}var Ee=t=>class extends t{constructor(...t){super(...t),this._isCIM=!1,this.geometryType=Q.TEXT,this._aux=tt(0,0,this._referenceSize,this._bitset)}bindTextInfo(t,e){t&&t.length?this._shapingInfo=f(t,(t=>At(t,e,{scale:this._scale,angle:this._angle,xOffset:this._xOffset,yOffset:this._yOffset,hAlign:this._xAlignD,vAlign:this._yAlignD,maxLineWidth:Math.max(32,Math.min(this._lineWidth,512)),lineHeight:K*Math.max(.25,Math.min(this._lineHeight,4)),decoration:this._decoration,isCIM:this._isCIM}))):this._shapingInfo=null}writeMeshWithGeometry(t,e,i,s,r,n){if(u(this._textPlacement)){const s=null!=n?n:i.readLegacyGeometry();return this._writePlacedText(t,e,r,s)}const o=n?G(X(n),2):"esriGeometryPolygon"===s?i.readCentroid():i.readUnquantizedGeometry();if(o){if(o.isPoint){const[i,s]=o.coords;return this._writeGlyphs(t,e,r,{x:i,y:s})}o.forEachVertex(((i,s)=>this._writeGlyphs(t,e,r,{x:i,y:s})))}}_writePlacedText(t,e,i,s){const n=this._shapingInfo;if(m(n))return;const o=Mt.load(this._materialKey),a=d(this._textPlacement),l=We.getPlacement(s,a,r(1));if(!l)return;let h,c,f=l.next();for(;null!=f;){c=et(Math.round(8*f.tx),Math.round(8*f.ty)),h=f.getAngle(),n.setRotation(h);for(const s of n.glyphs){o.textureBinding=s.textureBinding;const r=e.getVector("geometry").vertexCount,n=e.indexVector.length,a=this._writeIndices(e),l=this._writeVertex(e,i,c,s);t.writeDisplayRecord(this.geometryType,o.data,r,l,n,a)}n.setRotation(-h),f=l.next()}}_writeGlyphs(t,e,i,s){const r=this._shapingInfo;if(m(r))return;const n=Mt.load(this._materialKey),o=et(Math.round(8*s.x),Math.round(8*s.y));for(const s of r.glyphs){n.textureBinding=s.textureBinding;const r=e.getVector("geometry").vertexCount,a=e.indexVector.length,l=this._writeIndices(e),h=this._writeVertex(e,i,o,s);t.writeDisplayRecord(this.geometryType,n.data,r,h,a,l)}}_writeVertexCommon(t,e,i,s){const r=this._color,n=this._haloColor,o=tt(0,0,this._referenceSize,this._bitset),a=tt(0,0,this._size,this._haloSize);t.push(i),t.push(e),t.push(r),t.push(n),t.push(a),t.push(o)}_writeVertex(t,e,i,s){const r=t.get("geometry");return this._writeVertexCommon(r,e,i,s),r.push(s.offsets.upperLeft),r.push(s.texcoords.upperLeft),this._writeVertexCommon(r,e,i,s),r.push(s.offsets.upperRight),r.push(s.texcoords.upperRight),this._writeVertexCommon(r,e,i,s),r.push(s.offsets.lowerLeft),r.push(s.texcoords.lowerLeft),this._writeVertexCommon(r,e,i,s),r.push(s.offsets.lowerRight),r.push(s.texcoords.lowerRight),4}_writeIndices(t){const e=t.getVector("geometry").vertexCount,i=t.indexVector;return i.push(e+0),i.push(e+1),i.push(e+2),i.push(e+1),i.push(e+3),i.push(e+2),6}};class Ke{static executeEffects(t,e){const i=Rt(e);let s=new Dt(i);for(const e of t){const t=Nt(e);t&&(s=t.execute(s,e,1.3333333333333333))}return s}static next(t){const e=t.next();return Ft(e),e}}class Ye{get needsPixelBuffer(){return!!this.effects||this.geometryType===Q.MARKER||this.geometryType===Q.TEXT||this.geometryType===Q.LABEL}writeMesh(t,e,i,s,r){if(m(this.effects))return this.writeMeshWithGeometry(t,e,i,s,r);const n=Ke.executeEffects(this.effects,i.readLegacyGeometry());let o=Ke.next(n);for(;o;)this.writeMeshWithGeometry(t,e,i,p(o),r,o),o=Ke.next(n)}writeMeshWithGeometry(t,e,i,s,r,n){}bindFeature(t,e,i){}}class Ze extends(Ee(Ye)){constructor(t,e,i,s,n,o,a,l,h,c,f,u,m,d,p,_,g,x=!1){super(),this._xOffset=r(u),this._yOffset=r(m),this._decoration=h||"none",this._color=s,this._haloColor=n,this._haloSize=Math.min(Math.floor(5*r(y(i))),127),this._size=Math.min(Math.round(r(e)),127);const M=Math.min(Math.round(r(e)),127);this._referenceSize=Math.round(Math.sqrt(256*M)),this._scale=this._size/24,this._angle=f,this._justify=Gt(o||"center"),this._xAlignD=Xt(o||"center"),this._yAlignD=Vt(a||"baseline"),this._baseline="baseline"===(a||"baseline"),this._bitset=(1===l?1:0)|(c?1:0)<<1;const b=Mt.load(t);b.sdf=!0,this._materialKey=b.data,this._lineWidth=r(d)||512,this._lineHeight=p||1,this._textPlacement=_,this.effects=g,this._isCIM=x}static fromText(t,e){const i=new Ze(t.materialKey,t.font.size,t.haloSize||0,t.color&&nt(t.color)||0,t.haloColor&&nt(t.haloColor)||0,t.horizontalAlignment,t.verticalAlignment,0,t.font.decoration,!1,t.angle||0,t.xoffset,t.yoffset,t.lineWidth,t.lineHeight,null,null,!1),[,s]=Bt(t.text);return i.bindTextInfo(e,s),i}static fromCIMText(t,e){const i=t.scaleFactor||1,s=new Ze(t.materialKey,t.size*t.sizeRatio*i,t.outlineSize*t.sizeRatio,ot(t.color),ot(t.outlineColor),t.horizontalAlignment,t.verticalAlignment,t.alignment,t.decoration,t.colorLocked,t.angle,t.offsetX*t.sizeRatio*i,t.offsetY*t.sizeRatio*i,512,1,t.markerPlacement,t.effects,!0),[,r]=Bt(t.text);return s.bindTextInfo(e,r),s}}var Ue=t=>class extends t{constructor(...t){super(...t),this.angle=0,this.xOffset=0,this.yOffset=0,this.width=0,this.height=0,this.boundsType="square",this._anchorX=0,this._anchorY=0,this._computedWidth=0,this._computedHeight=0,this.geometryType=Q.MARKER}writeMeshWithGeometry(t,e,i,s,r,n){const o=e.indexVector,a=e.get("geometry"),l=e.getVector("geometry"),h=l.vertexCount,c=h,f=o.length;if(u(this._markerPlacement)){const t=null!=n?n:i.readLegacyGeometry();this._writePlacedMarkers(a,o,h,r,t)}else{const t=n?G(X(n),2):"esriGeometryPolygon"===s?i.readCentroid():i.readUnquantizedGeometry();if(!t)return;if(t.isPoint){const[e,i]=t.coords;this._writeVertices(a,r,this._getPos(e,i)),this._writeIndices(o,h)}else t.forEachVertex(((t,e)=>{const i=l.vertexCount;this._writeVertices(a,r,this._getPos(t,e)),this._writeIndices(o,i)}))}const m=e.getVector("geometry").vertexCount-c,d=o.length-f;t.writeDisplayRecord(this.geometryType,this._materialKey,c,m,f,d)}_applyTransformation(t,e,i=0){_(t),g(t,t,x(this.xOffset,-this.yOffset)),this.angle+i!==0&&M(t,t,.017453292519944444*(this.angle+i));const s=this._computedWidth,r=this._computedHeight,n=(this._anchorX-.5)*s,o=(this._anchorY-.5)*r;b(e,n,o),w(e,e,t),this._offsetUpperLeft=et(16*e[0],16*e[1]),b(e,n+s,o),w(e,e,t),this._offsetUpperRight=et(16*e[0],16*e[1]),b(e,n,o+r),w(e,e,t),this._offsetBottomLeft=et(16*e[0],16*e[1]),b(e,n+s,o+r),w(e,e,t),this._offsetBottomRight=et(16*e[0],16*e[1])}_writePlacedMarkers(t,e,i,s,n){const o=We.getPlacement(n,d(this._markerPlacement),r(1));if(!o)return;const a=S(),l=v();let h=0,c=o.next();for(;null!=c;)c.tx>=-128&&c.tx<=640&&c.ty>=-128&&c.ty<=640&&(this._applyTransformation(l,a,c.getAngle()/.017453292519944444),this._writeVertices(t,s,this._getPos(c.tx,c.ty)),this._writeIndices(e,i+h),h+=4),c=o.next()}_getPos(t,e){return et(Math.round(8*t),Math.round(8*e))}_writeVertices(t,e,i){t.push(i),t.push(this._offsetUpperLeft),t.push(this._texUpperLeft),t.push(this._bitestAndDistRatio),t.push(e),t.push(this._fillColor),t.push(this._outlineColor),t.push(this._sizeOutlineWidth),t.push(i),t.push(this._offsetUpperRight),t.push(this._texUpperRight),t.push(this._bitestAndDistRatio),t.push(e),t.push(this._fillColor),t.push(this._outlineColor),t.push(this._sizeOutlineWidth),t.push(i),t.push(this._offsetBottomLeft),t.push(this._texBottomLeft),t.push(this._bitestAndDistRatio),t.push(e),t.push(this._fillColor),t.push(this._outlineColor),t.push(this._sizeOutlineWidth),t.push(i),t.push(this._offsetBottomRight),t.push(this._texBottomRight),t.push(this._bitestAndDistRatio),t.push(e),t.push(this._fillColor),t.push(this._outlineColor),t.push(this._sizeOutlineWidth)}_writeIndices(t,e){const i=e;t.push(i+0),t.push(i+1),t.push(i+2),t.push(i+1),t.push(i+3),t.push(i+2)}};class je extends(Ue(Ye)){constructor(t,e,i,s,r,n,o,a,l,h,c,f,u,m,d,p,y,_,g,x,M){super(),this.angle=s,this.height=o,this.width=n,this.xOffset=e*g,this.yOffset=i*g,this._markerPlacement=x,this.effects=M,this._anchorX=.5-(.5+p)*d.width/d.width,this._anchorY=.5-(.5+y)*d.height/d.height;const b=(1===m?1:0)|(c?1:0)<<1|(u?1:0)<<2|(f?1:0)<<3,w=d&&d.sdf,C=bt.load(t);C.sdf=w,C.pattern=!0,C.textureBinding=d.textureBinding,this._materialKey=C.data,this._fillColor=r,this._outlineColor=l,this._sizeOutlineWidth=tt(Math.round(Math.min(Math.sqrt(128*n),255)),Math.round(Math.min(Math.sqrt(128*o),255)),Math.round(Math.min(Math.sqrt(128*h),255)),Math.round(Math.min(Math.sqrt(128*a),255)));const L=d.rect.x+Y,P=d.rect.y+Y,k=L+d.width,T=P+d.height;this._texUpperLeft=et(L,P),this._texUpperRight=et(k,P),this._texBottomLeft=et(L,T),this._texBottomRight=et(k,T),n*=_,o*=_,n*=g,o*=g;const z=Math.round(Math.min(64*_,255));this._bitestAndDistRatio=tt(0,0,b,z),this._computedWidth=n,this._computedHeight=o;const I=S(),O=v();this._applyTransformation(O,I)}static fromCIMMarker(t,e){const i=e&&e.width||1,s=e&&e.height||1,n=t.size,o=i/s*t.scaleX,a=t.scaleSymbolsProportionally&&t.frameHeight?n/t.frameHeight:1,l=ot(t.color),h=ot(t.outlineColor),c=r(n),f=c*o,u=r(t.offsetX||0),m=r(t.offsetY||0),d=r(t.outlineWidth||0)*a,p=t.alignment||0,y=r(t.referenceSize);let _=t.rotation||0;t.rotateClockwise||(_=-_);let g=0,x=0;const M=t.anchorPoint;return M&&(t.isAbsoluteAnchorPoint?n&&(g=-M.x/(n*o),x=M.y/n):(g=M.x,x=M.y)),new je(t.materialKey,u,m,_,l,f,c,y,h,d,t.colorLocked,t.scaleSymbolsProportionally,!1,p,e,g,x,t.sizeRatio,C(t.scaleFactor,1),t.markerPlacement,t.effects)}static fromPictureMarker(t,e){const i=Math.round(r(t.width)),s=Math.round(r(t.height)),n=Z,o=Math.round(r(t.xoffset||0)),a=Math.round(r(t.yoffset||0));return new je(t.materialKey,o,a,t.angle,n,i,s,s,0,0,!1,!1,!1,0,e,0,0,1,1,null,null)}static fromSimpleMarker(t,e){const i=nt(t.color),s=Math.round(r(t.size)),n=s,o=Math.round(r(t.xoffset||0)),a=Math.round(r(t.yoffset||0)),l=t.style,h=t.outline,c=0|(h&&h.color&&nt(h.color)),f=0|(h&&h.width&&Math.round(r(h.width))),u=new je(t.materialKey,o,a,t.angle,i,s,n,n,c,f,!1,!1,"esriSMSCross"===l||"esriSMSX"===l,0,e,0,0,126/64,1,null,null);return u.boundsType="esriSMSCircle"===l?"circle":"square",u}static fromLineSymbolMarker(t,e){const i=nt(t.color),s=Math.round(r(6*t.lineWidth)),n=s,o="cross"===t.style||"x"===t.style;let a;switch(t.placement){case"begin-end":a="Both";break;case"begin":a="JustBegin";break;case"end":a="JustEnd";break;default:a="None"}const l={type:"CIMMarkerPlacementAtExtremities",angleToLine:!0,offset:0,extremityPlacement:a,offsetAlongLine:0},h=new je(t.materialKey,0,0,0,i,s,n,n/6,i,o?Math.round(r(t.lineWidth)):0,!1,!1,o,1,e,0,0,126/64,1,l,null);return h.boundsType="circle"===t.style?"circle":"square",h}}function qe(t,e,i,s,r,n,o){Mi=0;const a=(s-i)*n,l=r&&r.length,h=l?(r[0]-i)*n:a;let c,f,u,m,d,p=Je(e,i,s,0,h,n,!0);if(p&&p.next!==p.prev){if(l&&(p=function(t,e,i,s,r,n){const o=new Array;for(let r=0,a=s.length;r<a;r++){const l=Je(t,e,i,s[r]*n,r<a-1?s[r+1]*n:i*n,n,!1);l===l.next&&(l.steiner=!0),o.push(ri(l))}o.sort(mi);for(const t of o)ni(t,r),r=$e(r,r.next);return r}(e,i,s,r,p,n)),a>80*n){c=u=e[0+i*n],f=m=e[1+i*n];for(let t=n;t<h;t+=n){const s=e[t+i*n],r=e[t+1+i*n];c=Math.min(c,s),f=Math.min(f,r),u=Math.max(u,s),m=Math.max(m,r)}d=Math.max(u-c,m-f),d=0!==d?1/d:0}Qe(p,t,n,c,f,d,o,0)}}function Je(t,e,i,s,r,n,o){let a;if(o===function(t,e,i,s,r,n){let o=0;for(let i=s,a=r-n;i<r;i+=n)o+=(t[a+e*n]-t[i+e*n])*(t[i+1+e*n]+t[a+1+e*n]),a=i;return o}(t,e,0,s,r,n)>0)for(let i=s;i<r;i+=n)a=ii(i+e*n,t[i+e*n],t[i+1+e*n],a);else for(let i=r-n;i>=s;i-=n)a=ii(i+e*n,t[i+e*n],t[i+1+e*n],a);return a&&ui(a,a.next)&&(si(a),a=a.next),a}function $e(t,e=t){if(!t)return t;let i,s=t;do{if(i=!1,s.steiner||!ui(s,s.next)&&0!==ai(s.prev,s,s.next))s=s.next;else{if(si(s),s=e=s.prev,s===s.next)break;i=!0}}while(i||s!==e);return e}function Qe(t,e,i,s,r,n,o,a){if(!t)return;!a&&n&&(t=oi(t,s,r,n));let l=t;for(;t.prev!==t.next;){const h=t.prev,c=t.next;if(n?ei(t,s,r,n):ti(t))e.push(h.index/i+o),e.push(t.index/i+o),e.push(c.index/i+o),si(t),t=c.next,l=c.next;else if((t=c)===l){a?1===a?Qe(t=di(t,e,i,o),e,i,s,r,n,o,2):2===a&&pi(t,e,i,s,r,n,o):Qe($e(t),e,i,s,r,n,o,1);break}}}function ti(t){const e=t.prev,i=t,s=t.next;if(ai(e,i,s)>=0)return!1;let r=t.next.next;const n=r;let o=0;for(;r!==t.prev&&(0===o||r!==n);){if(o++,hi(e.x,e.y,i.x,i.y,s.x,s.y,r.x,r.y)&&ai(r.prev,r,r.next)>=0)return!1;r=r.next}return!0}function ei(t,e,i,s){const r=t.prev,n=t,o=t.next;if(ai(r,n,o)>=0)return!1;const a=r.x<n.x?r.x<o.x?r.x:o.x:n.x<o.x?n.x:o.x,l=r.y<n.y?r.y<o.y?r.y:o.y:n.y<o.y?n.y:o.y,h=r.x>n.x?r.x>o.x?r.x:o.x:n.x>o.x?n.x:o.x,c=r.y>n.y?r.y>o.y?r.y:o.y:n.y>o.y?n.y:o.y,f=fi(a,l,e,i,s),u=fi(h,c,e,i,s);let m=t.prevZ,d=t.nextZ;for(;m&&m.z>=f&&d&&d.z<=u;){if(m!==t.prev&&m!==t.next&&hi(r.x,r.y,n.x,n.y,o.x,o.y,m.x,m.y)&&ai(m.prev,m,m.next)>=0)return!1;if(m=m.prevZ,d!==t.prev&&d!==t.next&&hi(r.x,r.y,n.x,n.y,o.x,o.y,d.x,d.y)&&ai(d.prev,d,d.next)>=0)return!1;d=d.nextZ}for(;m&&m.z>=f;){if(m!==t.prev&&m!==t.next&&hi(r.x,r.y,n.x,n.y,o.x,o.y,m.x,m.y)&&ai(m.prev,m,m.next)>=0)return!1;m=m.prevZ}for(;d&&d.z<=u;){if(d!==t.prev&&d!==t.next&&hi(r.x,r.y,n.x,n.y,o.x,o.y,d.x,d.y)&&ai(d.prev,d,d.next)>=0)return!1;d=d.nextZ}return!0}function ii(t,e,i,s){const r=gi.create(t,e,i);return s?(r.next=s.next,r.prev=s,s.next.prev=r,s.next=r):(r.prev=r,r.next=r),r}function si(t){t.next.prev=t.prev,t.prev.next=t.next,t.prevZ&&(t.prevZ.nextZ=t.nextZ),t.nextZ&&(t.nextZ.prevZ=t.prevZ)}function ri(t){let e=t,i=t;do{(e.x<i.x||e.x===i.x&&e.y<i.y)&&(i=e),e=e.next}while(e!==t);return i}function ni(t,e){if(e=function(t,e){let i=e;const s=t.x,r=t.y;let n,o=-1/0;do{if(r<=i.y&&r>=i.next.y&&i.next.y!==i.y){const t=i.x+(r-i.y)*(i.next.x-i.x)/(i.next.y-i.y);if(t<=s&&t>o){if(o=t,t===s){if(r===i.y)return i;if(r===i.next.y)return i.next}n=i.x<i.next.x?i:i.next}}i=i.next}while(i!==e);if(!n)return null;if(s===o)return n.prev;const a=n,l=n.x,h=n.y;let c,f=1/0;for(i=n.next;i!==a;)s>=i.x&&i.x>=l&&s!==i.x&&hi(r<h?s:o,r,l,h,r<h?o:s,r,i.x,i.y)&&(c=Math.abs(r-i.y)/(s-i.x),(c<f||c===f&&i.x>n.x)&&ci(i,t)&&(n=i,f=c)),i=i.next;return n}(t,e)){const i=_i(e,t);$e(i,i.next)}}function oi(t,e,i,s){for(let r;r!==t;r=r.next){if(r=r||t,null===r.z&&(r.z=fi(r.x,r.y,e,i,s)),r.prev.next!==r||r.next.prev!==r)return r.prev.next=r,r.next.prev=r,oi(t,e,i,s);r.prevZ=r.prev,r.nextZ=r.next}return t.prevZ.nextZ=null,t.prevZ=null,function(t){let e,i=1;for(;;){let s,r=t;t=null,e=null;let n=0;for(;r;){n++,s=r;let o=0;for(;o<i&&s;o++)s=s.nextZ;let a=i;for(;o>0||a>0&&s;){let i;0===o?(i=s,s=s.nextZ,a--):0!==a&&s?r.z<=s.z?(i=r,r=r.nextZ,o--):(i=s,s=s.nextZ,a--):(i=r,r=r.nextZ,o--),e?e.nextZ=i:t=i,i.prevZ=e,e=i}r=s}if(e.nextZ=null,i*=2,n<2)return t}}(t)}function ai(t,e,i){return(e.y-t.y)*(i.x-e.x)-(e.x-t.x)*(i.y-e.y)}function li(t,e,i,s){return!!(ui(t,e)&&ui(i,s)||ui(t,s)&&ui(i,e))||ai(t,e,i)>0!=ai(t,e,s)>0&&ai(i,s,t)>0!=ai(i,s,e)>0}function hi(t,e,i,s,r,n,o,a){return(r-o)*(e-a)-(t-o)*(n-a)>=0&&(t-o)*(s-a)-(i-o)*(e-a)>=0&&(i-o)*(n-a)-(r-o)*(s-a)>=0}function ci(t,e){return ai(t.prev,t,t.next)<0?ai(t,e,t.next)>=0&&ai(t,t.prev,e)>=0:ai(t,e,t.prev)<0||ai(t,t.next,e)<0}function fi(t,e,i,s,r){return(t=1431655765&((t=858993459&((t=252645135&((t=16711935&((t=32767*(t-i)*r)|t<<8))|t<<4))|t<<2))|t<<1))|(e=1431655765&((e=858993459&((e=252645135&((e=16711935&((e=32767*(e-s)*r)|e<<8))|e<<4))|e<<2))|e<<1))<<1}function ui(t,e){return t.x===e.x&&t.y===e.y}function mi(t,e){return t.x-e.x}function di(t,e,i,s){let r=t;do{const n=r.prev,o=r.next.next;!ui(n,o)&&li(n,r,r.next,o)&&ci(n,o)&&ci(o,n)&&(e.push(n.index/i+s),e.push(r.index/i+s),e.push(o.index/i+s),si(r),si(r.next),r=t=o),r=r.next}while(r!==t);return r}function pi(t,e,i,s,r,n,o){let a=t;do{let t=a.next.next;for(;t!==a.prev;){if(a.index!==t.index&&yi(a,t)){let l=_i(a,t);return a=$e(a,a.next),l=$e(l,l.next),Qe(a,e,i,s,r,n,o,0),void Qe(l,e,i,s,r,n,o,0)}t=t.next}a=a.next}while(a!==t)}function yi(t,e){return t.next.index!==e.index&&t.prev.index!==e.index&&!function(t,e){let i=t;do{if(i.index!==t.index&&i.next.index!==t.index&&i.index!==e.index&&i.next.index!==e.index&&li(i,i.next,t,e))return!0;i=i.next}while(i!==t);return!1}(t,e)&&ci(t,e)&&ci(e,t)&&function(t,e){let i=t,s=!1;const r=(t.x+e.x)/2,n=(t.y+e.y)/2;do{i.y>n!=i.next.y>n&&i.next.y!==i.y&&r<(i.next.x-i.x)*(n-i.y)/(i.next.y-i.y)+i.x&&(s=!s),i=i.next}while(i!==t);return s}(t,e)}function _i(t,e){const i=gi.create(t.index,t.x,t.y),s=gi.create(e.index,e.x,e.y),r=t.next,n=e.prev;return t.next=e,e.prev=t,i.next=r,r.prev=i,s.next=i,i.prev=s,n.next=s,s.prev=n,s}class gi{constructor(){this.index=0,this.x=0,this.y=0,this.prev=null,this.next=null,this.z=null,this.prevZ=null,this.nextZ=null,this.steiner=!1}static create(t,e,i){const s=xi[Mi++];return s.index=t,s.x=e,s.y=i,s.prev=null,s.next=null,s.z=null,s.prevZ=null,s.nextZ=null,s.steiner=!1,s}}const xi=new Array;let Mi=0;for(let t=0;t<8096;t++)xi.push(new gi);const bi=new at,wi=new lt(0,0,0,1,128);function vi(t,e,i){let s=0;for(let r=1;r<i;r++){const i=t[2*(e+r-1)],n=t[2*(e+r-1)+1];s+=(t[2*(e+r)]-i)*(t[2*(e+r)+1]+n)}return s}function Si(t,e,i,s,r){let n=0;for(let o=i;o<s;o+=3){const i=2*(t.getValue(o)-r),s=2*(t.getValue(o+1)-r),a=2*(t.getValue(o+2)-r);n+=Math.abs((e[i]-e[a])*(e[s+1]-e[i+1])-(e[i]-e[s])*(e[a+1]-e[i+1]))}return n}wi.setExtent(U);var Ci=t=>class extends t{constructor(...t){super(...t),this.forceLibtess=!1,this.geometryType=Q.FILL}writeMeshWithGeometry(t,e,i,s,r,n){const o=wt.load(this._materialKey),a=e.indexVector,l=e.getVector("geometry"),h=l.vertexCount,c=a.length;let f=n?G(X(n),2):i.readUnquantizedGeometry();if(!f)return;if(f=function(t){if(!function(t,e,i){let s=0;for(let e=0;e<t.lengths.length;e++){const r=t.lengths[e];for(let e=0;e<r;e++){const r=t.coords[2*(e+s)],n=t.coords[2*(e+s)+1];if(r<-128||r>i||n<-128||n>i)return!0}s+=r}return!1}(t,0,U+128))return t;wi.reset(3);let e=0;for(let i=0;i<t.lengths.length;i++){const s=t.lengths[i];let r=t.coords[2*(0+e)],n=t.coords[2*(0+e)+1];wi.moveTo(r,n);for(let i=1;i<s;i++)r=t.coords[2*(i+e)],n=t.coords[2*(i+e)+1],wi.lineTo(r,n);wi.close(),e+=s}const i=wi.result(!1);if(!i)return null;const s=[],r=[];for(const t of i){let e=0;for(const i of t)r.push(i.x),r.push(i.y),e++;s.push(e)}return new V(s,r)}(f),!f)return;let u=f.coords;!this.forceLibtess&&function(t,e,i){const{coords:s,lengths:r,hasIndeterminateRingOrder:n}=e;if(n)return!1;const o=t.length;let a=0;for(let e=0;e<r.length;){let n=e,l=r[e],h=vi(s,a,l);const c=[];for(;++n<r.length;){const t=r[n],e=vi(s,a+l,t);if(!(e>0))break;h+=e,c.push(a+l),l+=t}const f=t.length;qe(t,s,a,a+l,c,2,i);const u=Si(t,s,f,t.length,i),m=Math.abs(h);if(Math.abs((u-m)/Math.max(1e-7,m))>1e-5)return t.seek(o),!1;e=n,a+=l}return!0}(a,f,h)||(u=[],function(t,e,i,s){const r=[],{coords:n,lengths:o}=i;bi.beginPolygon(t,r);let a=0;for(let t=0;t<o.length;t++){const e=i.lengths[t];bi.beginContour();for(let t=0;t<e;t++){const e=[n[2*(a+t)],n[2*(a+t)+1],0];bi.addVertex(e,e)}bi.endContour(),a+=e}bi.endPolygon();for(let t=0;t<r.length;t++)e.push(r[t]+s)}(u,a,f,h)),this._write(l,i,r,u,o);const m=l.vertexCount-h,d=a.length-c;t.writeDisplayRecord(this.geometryType,this._materialKey,h,m,c,d)}_write(t,e,i,s,r){for(let n=0;n<s.length;n+=2){const o=et(1*s[n],1*s[n+1]);t.data.push(o),t.data.push(i),r.dotDensity?t.data.writeF32(1/Math.abs(e.readGeometryArea())):(t.data.push(this.fillColor),t.data.push(this.tl),t.data.push(this.br),t.data.push(this.aux1),t.data.push(this.aux2),t.data.push(this.aux3))}}};const Li=i.getLogger("esri.views.2d.engine.webgl.WGLDynamicMeshTemplate");class Pi extends Ye{constructor(t){super(),this._ongoingMaterialRequestMap=new Map,this._materialCache=new Map,this._dynamicPropertyMap=new Map,this._cimLayer=t}analyze(t,e,i,s){const r=e.readLegacyFeature(),n=this._materialCache,o=this._cimLayer.materialHash;if(!o)return Li.error("A Dynamic mesh template must have a material hash value or function!"),L(null);const a="function"==typeof o?o(r,i,s):o;if(n.has(a)){const t=n.get(a);return P(t)}if(this._ongoingMaterialRequestMap.has(a))return this._ongoingMaterialRequestMap.get(a);const l=function(t,e){if(!e||0===e.length)return t;const i=JSON.parse(JSON.stringify(t));return zt.applyOverrides(i,e),i}(this._cimLayer.cim,this._cimLayer.materialOverrides);l.mosaicHash=a;const h=t.getMosaicItem(l).then((t=>(this._ongoingMaterialRequestMap.delete(a),n.set(a,t),t))).catch((t=>(this._ongoingMaterialRequestMap.delete(a),Li.error(".analyze()",t.message),null)));return this._ongoingMaterialRequestMap.set(a,h),h}}class ki extends(Ci(Pi)){constructor(t){if(super(t),ht(t.color)){const e=(e,i,s)=>{const r=t.color(e,i,s);return r&&ot(r)||0};this._dynamicPropertyMap.set("_fillColor",e)}else{const e=t.color;this.fillColor=e&&ot(e)||0}let e=0;ht(t.height)||(e=t.height||0),this._dynamicPropertyMap.set("_height",((i,s,r)=>ht(t.height)?t.height(i,s,r):e));let i=0;ht(t.offsetX)||(i=r(t.offsetX||0)+128,i>255&&(i=255)),this._dynamicPropertyMap.set("_offsetX",((e,s,n)=>{if(ht(t.offsetX)){let i=r(t.offsetX(e,s,n))+128;return i>255&&(i=255),i}return i}));let s=1;ht(t.scaleX)||(s=t.scaleX||1),this._dynamicPropertyMap.set("_scaleX",((e,i,r)=>ht(t.scaleX)?t.scaleX(e,i,r):s));let n=0;ht(t.offsetY)||(n=r(-t.offsetY||0)+128,n>255&&(n=255)),this._dynamicPropertyMap.set("_offsetY",((e,i,s)=>{if(ht(t.offsetY)){let n=r(-t.offsetY(e,i,s))+128;return n>255&&(n=255),n}return n}));let o=0;ht(t.angle)||(o=_t(t.angle)||0),this._dynamicPropertyMap.set("_angle",((e,i,s)=>ht(t.angle)?_t(t.angle(e,i,s)):o)),this.effects=t.effects,this._cimFillLayer=t,this._fillMaterialKey=wt.load(t.materialKey)}static fromCIMFill(t){return new ki(t)}bindFeature(t,e,i){const s=t.readLegacyFeature();this._dynamicPropertyMap.forEach(((t,r)=>{this[r]=t(s,e,i)}));const n=this._fillMaterialKey,o=this._materialCache,a=this._cimFillLayer;this.aux3=tt(0,0,this._angle,a.colorLocked?1:0);const l=(0,a.materialHash)(s,e,i),h=o.get(l);let c=null;if(h&&ne(h.spriteMosaicItem)&&(c=h.spriteMosaicItem),c){const{rect:t,width:e,height:i}=c,s=t.x+Y,o=t.y+Y,a=s+e,l=o+i;let h=k(r(this._height));h>255?h=255:h<=0&&(h=k(l-o));let f=k(r(this._height/i*e||0));f>255?f=255:f<=0&&(f=k(a-s));const u=this._scaleX,m=1;this.tl=et(s,o),this.br=et(a,l),this.aux1=tt(f,h,this._offsetX,this._offsetY),this.aux2=et(128*u,128*m),n.sdf=c.sdf,n.pattern=!0,n.textureBinding=c.textureBinding}else this.tl=0,this.br=0,this.aux1=0,this.aux2=0,n.sdf=!1,n.pattern=!1,n.textureBinding=0;this._materialKey=n.data}}const Ti=U+16,zi=new lt(0,0,0,1,16);zi.setExtent(U);const Ii=new Uint32Array(9),Oi=new Uint32Array(36),Ri=new Uint32Array(3),Ai=new Uint32Array(6),Ni=t=>e=>{const i=Math.ceil(1024*t._halfWidth),s=Math.ceil(1024*t._halfReferenceWidth);e.entry0=t.offset+t.vertexCount++;{const r=et(e.distance,i),n=tt(Math.round(31*e.prevNormal.x),Math.round(31*e.prevNormal.y),Math.round(0),Math.round(-31)),o=tt(0,0,0,t._bitset);Oi[0]=et(8*e.currentVertex.x,8*e.currentVertex.y),Oi[1]=t.id,Oi[2]=t._fillColor,Oi[3]=n,Oi[4]=r,Oi[5]=t._tl,Oi[6]=t._br,Oi[7]=o,Oi[8]=et(s,0)}e.entry2=t.offset+t.vertexCount++;{const r=et(e.distance,i),n=tt(Math.round(31*-e.prevNormal.x),Math.round(31*-e.prevNormal.y),Math.round(0),Math.round(31)),o=tt(0,0,0,t._bitset);Oi[9]=et(8*e.currentVertex.x,8*e.currentVertex.y),Oi[10]=t.id,Oi[11]=t._fillColor,Oi[12]=n,Oi[13]=r,Oi[14]=t._tl,Oi[15]=t._br,Oi[16]=o,Oi[17]=et(s,0)}e.exit0=t.offset+t.vertexCount++;{const r=et(e.distance,i),n=tt(Math.round(31*e.nextNormal.x),Math.round(31*e.nextNormal.y),Math.round(0),Math.round(-31)),o=tt(0,0,0,t._bitset);Oi[18]=et(8*e.currentVertex.x,8*e.currentVertex.y),Oi[19]=t.id,Oi[20]=t._fillColor,Oi[21]=n,Oi[22]=r,Oi[23]=t._tl,Oi[24]=t._br,Oi[25]=o,Oi[26]=et(s,0)}e.exit2=t.offset+t.vertexCount++;{const r=et(e.distance,i),n=tt(Math.round(31*-e.nextNormal.x),Math.round(31*-e.nextNormal.y),Math.round(0),Math.round(31)),o=tt(0,0,0,t._bitset);Oi[27]=et(8*e.currentVertex.x,8*e.currentVertex.y),Oi[28]=t.id,Oi[29]=t._fillColor,Oi[30]=n,Oi[31]=r,Oi[32]=t._tl,Oi[33]=t._br,Oi[34]=o,Oi[35]=et(s,0)}t.geometryBuf.writeRegion(Oi)},Fi=t=>e=>{Ai[0]=e.leftExit0,Ai[1]=e.rightEntry0,Ai[2]=e.leftExit2,Ai[3]=e.rightEntry0,Ai[4]=e.rightEntry2,Ai[5]=e.leftExit2,t.indexCount+=6,t.indexBuf.writeRegion(Ai)};var Di=t=>class extends t{constructor(...t){super(...t),this.tessellationProperties={_fillColor:null,_tl:null,_br:null,_halfWidth:null,_bitset:null,_halfReferenceWidth:null,id:null,indexBuf:null,indexCount:null,geometryBuf:null,vertexCount:null,offset:null},this._tessellationOptions={},this.geometryType=Q.LINE}writeMeshWithGeometry(t,e,i,s,r,n){const o=e.indexVector,a=e.get("geometry"),l=e.getVector("geometry").vertexCount,h=o.length,c=null!=n?n:i.readLegacyGeometry();if(!c)return;switch(s){case"esriGeometryPolyline":{const t=this._clipLines(c.paths);if(0===t.length)return;this._write(o,a,l,r,t);break}case"esriGeometryPolygon":{const t=this._clipLines(c.rings);if(0===t.length)return;this._write(o,a,l,r,t);break}}const f=this.tessellationProperties.vertexCount,u=this.tessellationProperties.indexCount;t.writeDisplayRecord(this.geometryType,this._materialKey,l,f,h,u)}_clipLines(t){const e=[];let i=!1,s=0;for(;s<t.length;){const r=[],n=t[s];zi.reset(2);let[o,a]=n[0];if(i)zi.moveTo(o,a);else{if(o<-16||o>Ti||a<-16||a>Ti){i=!0;continue}r.push({x:o,y:a})}let l=!1;const h=n.length;for(let t=1;t<h;++t)if(o+=n[t][0],a+=n[t][1],i)zi.lineTo(o,a);else{if(o<-16||o>Ti||a<-16||a>Ti){l=!0;break}r.push({x:o,y:a})}if(l)i=!0;else{if(i){const t=zi.resultWithStarts();if(t)for(const i of t)e.push(i)}else e.push({line:r,start:0});s++,i=!1}}return e}_write(t,e,i,s,r){this.tessellationProperties.id=s,this.tessellationProperties.indexBuf=t,this.tessellationProperties.indexCount=0,this.tessellationProperties.geometryBuf=e,this.tessellationProperties.vertexCount=0,this.tessellationProperties.offset=i;for(const t of r){const e=t.line;e.length<2||(this._tessellationOptions.initialDistance=t.start%65535,this._tessellationCallbacks instanceof ct&&(this._tessellationCallbacks.capType=this._capType,this._tessellationCallbacks.joinType=this._joinType),ft(e,this._tessellationOptions,this._tessellationCallbacks),ut())}}_initializeTessellator(t){const e=vt.load(this._materialKey);if(this._tessellationOptions.trackDistance=this._isDashed||this._hasPattern,this._tessellationOptions.thin=!t&&this.tessellationProperties._halfWidth<j/2&&!(e.vvSizeFieldStops||e.vvSizeMinMaxValue||e.vvSizeScaleStops||e.vvSizeUnitValue),this._tessellationOptions.wrapDistance=65535,this._tessellationOptions.outerBisectorAutoSplitThreshold=.2631578947368421,this._tessellationOptions.enableOuterBisectorSplit=this._isDashed||this._hasPattern,this._tessellationOptions.innerBisectorAutoSplitThreshold=.2631578947368421,this._tessellationOptions.enableInnerBisectorSplit=this._isDashed||this._hasPattern,this._tessellationOptions.thin)this._tessellationCallbacks={vertex:Ni(this.tessellationProperties),bridge:Fi(this.tessellationProperties)};else{const t=new ct((t=>(e,i,s,r,n,o,a,l,h)=>{const c=et(h,Math.ceil(1024*t._halfWidth)),f=tt(Math.round(31*n),Math.round(31*o),Math.round(31*a),Math.round(31*l)),u=tt(31*s,31*r,0,t._bitset);return Ii[0]=et(8*e,8*i),Ii[1]=t.id,Ii[2]=t._fillColor,Ii[3]=f,Ii[4]=c,Ii[5]=t._tl,Ii[6]=t._br,Ii[7]=u,Ii[8]=et(Math.ceil(1024*t._halfReferenceWidth),0),t.geometryBuf.writeRegion(Ii),t.offset+t.vertexCount++})(this.tessellationProperties),(t=>(e,i,s)=>{Ri[0]=e,Ri[1]=i,Ri[2]=s,t.indexCount+=3,t.indexBuf.writeRegion(Ri)})(this.tessellationProperties));t.miterLimitCosine=this._miterLimitCosine,t.textured=this._isDashed||this._hasPattern,t.joinOnUTurn=this._joinOnUTurn,this._tessellationCallbacks=t}}};class Gi extends(Di(Pi)){constructor(t){super(t),this._cimLineLayer=t;let e=0;if(ht(t.width)||(e=.5*r(t.width)),this._dynamicPropertyMap.set("_halfWidth",((i,s,n)=>ht(t.width)?.5*r(t.width(i,s,n)):e)),ht(t.cap)?this._dynamicPropertyMap.set("_capType",t.cap):this._capType=t.cap,ht(t.join)?this._dynamicPropertyMap.set("_joinType",t.join):this._joinType=t.join,ht(t.color)){const e=(e,i,s)=>{const r=t.color(e,i,s);return r&&ot(r)||0};this._dynamicPropertyMap.set("_fillColor",e)}else{const e=t.color;this._fillColor=e&&ot(e)||0}if(ht(t.miterLimit)){const e=(e,i,s)=>mt(t.miterLimit(e,i,s));this._dynamicPropertyMap.set("_miterLimitCosine",e)}else this._miterLimitCosine=mt(t.miterLimit);this._scaleFactor=t.scaleFactor||1,this._isDashed=t.isDashed,this.effects=t.effects,this.tessellationProperties._bitset=t.colorLocked?1:0,this._materialKey=t.materialKey,this._initializeTessellator(!0)}static fromCIMLine(t){return new Gi(t)}bindFeature(t,e,i){const s=t.readLegacyFeature();this._dynamicPropertyMap.forEach(((t,r)=>{this[r]=t(s,e,i)})),this._halfWidth*=this._scaleFactor;const r=this._materialCache,n=(0,this._cimLineLayer.materialHash)(s,e,i),o=r.get(n);let a=null;if(o&&ne(o.spriteMosaicItem)&&(a=o.spriteMosaicItem),a){this._hasPattern=!0;const{rect:t,width:e,height:i}=a,s=t.x+Y,r=t.y+Y,n=s+e,o=r+i;this.tessellationProperties._tl=et(s,r),this.tessellationProperties._br=et(n,o)}else this._hasPattern=!1,this.tessellationProperties._tl=0,this.tessellationProperties._br=0;this.tessellationProperties._fillColor=this._fillColor,this.tessellationProperties._halfWidth=this._halfWidth,this.tessellationProperties._halfReferenceWidth=this.tessellationProperties._halfWidth;const l=vt.load(this._materialKey);a&&(l.sdf=a.sdf,l.pattern=!0,l.textureBinding=a.textureBinding),this._materialKey=l.data}}const Xi=S(),Vi=v(),Bi=i.getLogger("esri.views.2d.engine.webgl.WGLDynamicMarkerTemplate");class Hi extends(Ue(Pi)){constructor(t){if(super(t),this._cimMarkerLayer=t,ht(t.color)){const e=(e,i,s)=>ot(t.color(e,i,s));this._dynamicPropertyMap.set("_fillColor",e)}else this._fillColor=ot(t.color);if(ht(t.outlineColor)){const e=(e,i,s)=>ot(t.outlineColor(e,i,s));this._dynamicPropertyMap.set("_outlineColor",e)}else this._outlineColor=ot(t.outlineColor);if(ht(t.size)){const e=(e,i,s)=>r(t.size(e,i,s));this._dynamicPropertyMap.set("_size",e)}else this._size=r(t.size);if(ht(t.scaleX)?this._dynamicPropertyMap.set("_scaleX",t.scaleX):this._scaleX=t.scaleX,ht(t.offsetX)){const e=(e,i,s)=>r(t.offsetX(e,i,s));this._dynamicPropertyMap.set("xOffset",e)}else this.xOffset=r(t.offsetX);if(ht(t.offsetY)){const e=(e,i,s)=>r(t.offsetY(e,i,s));this._dynamicPropertyMap.set("yOffset",e)}else this.yOffset=r(t.offsetY);if(ht(t.outlineWidth)){const e=(e,i,s)=>r(t.outlineWidth(e,i,s));this._dynamicPropertyMap.set("_outlineWidth",e)}else this._outlineWidth=r(t.outlineWidth);ht(t.rotation)?this._dynamicPropertyMap.set("_angle",t.rotation):this._angle=t.rotation,this._scaleFactor=C(t.scaleFactor,1),this._markerPlacement=t.markerPlacement,this.effects=t.effects,this._bitSet=(1===t.alignment?1:0)|(t.colorLocked?1:0)<<1|(t.scaleSymbolsProportionally?1:0)<<3,this._materialKey=t.materialKey}static fromCIMMarker(t){return new Hi(t)}bindFeature(t,i,s){const n=t.readLegacyFeature();this._dynamicPropertyMap.forEach(((t,e)=>{this[e]=t(n,i,s)}));const o=this._cimMarkerLayer.materialHash,a="function"==typeof o?o(n,i,s):o,l=this._materialCache.get(a);if(!l||!ne(l.spriteMosaicItem)||!l.spriteMosaicItem)return void Bi.error(new e("mapview-cim","Encountered an error when binding feature"));const h=l.spriteMosaicItem,c=this._cimMarkerLayer.sizeRatio,f=h.width/h.height*this._scaleX,u=this._cimMarkerLayer.rotateClockwise?this._angle:-this._angle;let m=this._size,d=m*f;const p=this.xOffset,y=this.yOffset;this.xOffset*=this._scaleFactor,this.yOffset*=this._scaleFactor;const _=this._cimMarkerLayer.scaleSymbolsProportionally&&this._cimMarkerLayer.frameHeight?this._size/r(this._cimMarkerLayer.frameHeight):1,g=this._outlineWidth*_,x=r(this._cimMarkerLayer.referenceSize);let M=0,b=0;const w=this._cimMarkerLayer.anchorPoint;w&&(this._cimMarkerLayer.isAbsoluteAnchorPoint?this._size&&(M=-w.x/(this._size*f),b=w.y/this._size):(M=w.x,b=w.y)),this._sizeOutlineWidth=tt(Math.round(Math.min(Math.sqrt(128*d),255)),Math.round(Math.min(Math.sqrt(128*m),255)),Math.round(Math.min(Math.sqrt(128*g),255)),Math.round(Math.min(Math.sqrt(128*x),255))),this.angle=u;const v=Math.round(Math.min(64*c,255));this._bitestAndDistRatio=tt(0,0,this._bitSet,v);const S=h.rect.x+Y,C=h.rect.y+Y,L=S+h.width,P=C+h.height;this._texUpperLeft=et(S,C),this._texUpperRight=et(L,C),this._texBottomLeft=et(S,P),this._texBottomRight=et(L,P);const k=bt.load(this._materialKey);k.sdf=h.sdf,k.pattern=!0,k.textureBinding=h.textureBinding,this._materialKey=k.data,this._anchorX=.5-(.5+M)*h.width/h.width,this._anchorY=.5-(.5+b)*h.height/h.height,d*=c,m*=c,d*=this._scaleFactor,m*=this._scaleFactor,d*=h.rect.width/h.width,m*=h.rect.height/h.height,this._computedWidth=d,this._computedHeight=m,this._applyTransformation(Vi,Xi),this.xOffset=p,this.yOffset=y}}function Wi(t){const e=new Array(t.length);for(let i=0;i<t.length;i++)e[i]=t.charCodeAt(i);return e}class Ei extends(Ee(Pi)){constructor(t){super(t),this._horizontalAlignment="center",this._verticalAlignment="middle",this._textToGlyphs=new Map;const e=t.scaleFactor||1;if(this._cimTextLayer=t,ht(t.color)){const e=(e,i,s)=>ot(t.color(e,i,s));this._dynamicPropertyMap.set("_color",e)}else this._color=ot(t.color);if(ht(t.color)){const e=(e,i,s)=>ot(t.outlineColor(e,i,s));this._dynamicPropertyMap.set("_haloColor",e)}else this._haloColor=ot(t.outlineColor);let i,s,n;if(ht(t.size)||(i=Math.min(Math.round(r(t.size*t.sizeRatio)),127)),this._dynamicPropertyMap.set("_size",((e,s,n)=>ht(t.size)?Math.min(Math.round(r(t.size(e,s,n)*t.sizeRatio)),127):i)),ht(t.outlineSize)){const e=(e,i,s)=>Math.min(Math.floor(5*r(t.outlineSize(e,i,s)*t.sizeRatio)),127);this._dynamicPropertyMap.set("_haloSize",e)}else this._haloSize=Math.min(Math.floor(5*r(t.outlineSize*t.sizeRatio)),127);ht(t.offsetX)||(s=Math.round(r(t.offsetX*t.sizeRatio))),this._dynamicPropertyMap.set("_xOffset",((e,i,n)=>ht(t.offsetX)?Math.round(r(t.offsetX(e,i,n)*t.sizeRatio)):s)),ht(t.offsetY)||(n=Math.round(r(t.offsetY*t.sizeRatio))),this._dynamicPropertyMap.set("_yOffset",((e,i,s)=>ht(t.offsetY)?Math.round(r(t.offsetY(e,i,s)*t.sizeRatio)):n)),ht(t.angle)?this._dynamicPropertyMap.set("_angle",t.angle):this._angle=t.angle,ht(t.horizontalAlignment)?this._dynamicPropertyMap.set("_horizontalAlignment",t.horizontalAlignment):this._horizontalAlignment=t.horizontalAlignment,ht(t.verticalAlignment)?this._dynamicPropertyMap.set("_verticalAlignment",t.verticalAlignment):this._verticalAlignment=t.verticalAlignment,this._scaleFactor=e,ht(t.text)?this._dynamicPropertyMap.set("_text",t.text):this._text=t.text;const o=Math.min(Math.round(r(t.referenceSize*t.sizeRatio)),127);this._referenceSize=Math.round(Math.sqrt(256*o)),this._materialKey=t.materialKey;const a=St.load(this._materialKey);a.sdf=!0,this._bitset=(1===t.alignment?1:0)|(t.colorLocked?1:0)<<1,this._materialKey=a.data,this._decoration="none",this._lineHeight=1,this._lineWidth=512,this._textPlacement=t.markerPlacement,this.effects=t.effects,this._isCIM=!0}static fromCIMText(t){return new Ei(t)}async analyze(t,e,i,s){const r=e.readLegacyFeature(),n=function(t,e,i,s){return"string"==typeof t.text?t.text:"function"==typeof t.text?t.text(e,i,s):""}(this._cimTextLayer,r,i,s),o=await t.getMosaicItem(this._cimTextLayer.cim,Wi(n));return this._textToGlyphs.set(n,o.glyphMosaicItems),o}bindFeature(t,e,i){const s=t.readLegacyFeature();if(this._dynamicPropertyMap.forEach(((t,r)=>{this[r]=t(s,e,i)})),!this._text||0===this._text.length)return void(this._shapingInfo=null);this._size*=this._scaleFactor,this._scale=this._size/24,this._xOffset*=this._scaleFactor,this._yOffset*=this._scaleFactor,this._xAlignD=Xt(this._horizontalAlignment||"center"),this._yAlignD=Vt(this._verticalAlignment||"baseline");const r=this._textToGlyphs.get(this._text);this.bindTextInfo(r,!1)}}class Ki extends(Ci(Ye)){constructor(t,e,i,s,r,n,o,a,l){super(),this.effects=l;const h=wt.load(t);e&&(h.sdf=e.sdf,h.pattern=!0,h.textureBinding=e.textureBinding),this.fillColor=i,this.tl=s,this.br=r,this.aux1=n,this.aux2=o,this.aux3=a,this._materialKey=h.data}static fromCIMFill(t,e){const i=t.color,s=i&&ot(i)||0,n=t.materialKey;if(!e){const e=tt(0,0,0,t.colorLocked?1:0);return new Ki(n,null,s,0,0,0,0,e,t.effects)}const{rect:o,width:a,height:l}=e,h=o.x+Y,c=o.y+Y,f=h+a,u=c+l;let m=k(r(t.height||0));m>255?m=255:m<=0&&(m=k(u-c));let d=k(r(t.height/l*a||0));d>255?d=255:d<=0&&(d=k(f-h));let p=r(t.offsetX||0)+128;p>255&&(p=255);let y=r(-t.offsetY||0)+128;y>255&&(y=255);const _=t.scaleX||1,g=et(h,c),x=et(f,u),M=tt(d,m,p,y),b=et(128*_,128),w=tt(0,0,gt(t.angle),t.colorLocked?1:0);return new Ki(n,e,s,g,x,M,b,w,t.effects)}static fromSimpleFill(t,e,i=!1){const{color:s}=t,r=s&&"esriSFSNull"!==t.style&&nt(s)||0,n=tt(0,0,0,i?255:0),o=t.materialKey;if(!e)return new Ki(o,null,r,0,0,0,0,n,null);const{rect:a,width:l,height:h}=e,c=a.x+Y,f=a.y+Y,u=c+l,m=f+h,d=et(c,f),p=et(u,m),y=tt(k(u-c),k(m-f),0,0),_=et(128,128);return new Ki(o,e,r,d,p,y,_,n,null)}static fromPictureFill(t,e,i=!1){const s=Z,{rect:n,width:o,height:a}=e,l=n.x+Y,h=n.y+Y,c=l+o,f=h+a,u=et(l,h),m=et(c,f);let d=k(r(t.width));d>255&&(d=255);let p=k(r(t.height));p>255&&(p=255);let y=r(t.xoffset)+128;y>255&&(y=255);let _=r(-t.yoffset)+128;_>255&&(_=255);const g=tt(d,p,y,_),x=et(128*t.xscale,128*t.yscale),M=tt(0,0,0,i?255:0),b=t.materialKey;return new Ki(b,e,s,u,m,g,x,M,null)}}const Yi=i.getLogger("esri.views.2d.engine.webgl.WGLLineTemplate");class Zi extends(Di(Ye)){constructor(t,e,i,s,r,n,o,a,l,h,c,f,u,m,d,p){super();const y=vt.load(t);e&&(y.sdf=e.sdf,y.pattern=!0,y.textureBinding=e.textureBinding),this._capType=s,this._joinType=r,this._miterLimitCosine=mt(n),this.tessellationProperties._fillColor=o,this.tessellationProperties._tl=a,this.tessellationProperties._br=l,this._hasPattern=h,this._isDashed=c,this._joinOnUTurn=d,this._isColorLocked=f,this._zOrder=m,this.effects=p,this._materialKey=y.data,this.tessellationProperties._bitset=f?1:0,this.tessellationProperties._halfWidth=.5*i,this.tessellationProperties._halfReferenceWidth=.5*u,this._initializeTessellator(!1)}static fromCIMLine(t,e,i){const s=t.color,n=t.scaleFactor||1,o=t.isDashed;let a=t.cap;o&&1===a&&(a=2);const l=t.join,h=r(t.width)*n,c=r(t.referenceWidth),f=r(t.miterLimit),u=s&&ot(s)||0;if(!e)return new Zi(t.materialKey,e,h,a,l,f,u,0,0,!1,o,t.colorLocked,c,t.zOrder,i,t.effects);const{rect:m,width:d,height:p}=e,y=m.x+Y,_=m.y+Y,g=y+d,x=_+p,M=et(y,_),b=et(g,x);return new Zi(t.materialKey,e,h,a,l,f,u,M,b,!0,o,t.colorLocked,c,t.zOrder,i,t.effects)}static fromSimpleLine(t,e,i){const{color:s}=t,n="esriSLSSolid"!==t.style&&"esriSLSNull"!==t.style,o=it(t.cap||"round",n),a=st(t.join||"round");let l=s&&"esriSLSNull"!==t.style&&nt(s)||0;"esriSLSNull"===t.style&&(l=0);const h=r(t.width),c=t.miterLimit;if(!e)return new Zi(t.materialKey,e,h,o,a,c,l,0,0,!1,n,!1,h,0,i,null);const{rect:f,width:u,height:m}=e,d=f.x+Y,p=f.y+Y,y=d+u,_=p+m,g=et(d,p),x=et(y,_);return new Zi(t.materialKey,e,h,o,a,c,l,g,x,!0,n,!1,h,0,i,null)}static fromPictureLineSymbol(t,e,i,s){return Yi.error("PictureLineSymbol support does not exist!"),null}}class Ui{constructor(){this._resolver=null}isHeld(){return!!this._resolver}acquire(){return this._resolver?this._resolver.promise.then((()=>this.acquire())):(this._resolver=T(),P())}release(){const t=this._resolver;this._resolver=null,t.resolve()}}const ji=i.getLogger("esri.views.2d.engine.webgl.mesh.templates.WGLTemplateStore"),qi=new Array;function Ji(t,e){const i=t.length;return t.push(null),e.then((e=>t[i]=e)),t}function $i(t){return!!(1&t)}class Qi{constructor(t,e){this._idCounter=1,this._templateIdCounter=1,this._idToTemplateGroup=new Map,this._symbolToTemplate=new Map,this._fetchQueue=[],this._idToResolver=new Map,this._cimTemplateCache=new Map,this._cimAnalyses=[],this._lock=new Ui,this._fetchResource=t,this._joinOnUTurn=e}get _markerError(){return this._errorTemplates.marker[0]}get _fillError(){return this._errorTemplates.fill[0]}get _lineError(){return this._errorTemplates.line[0]}get _textError(){return this._errorTemplates.line[0]}createTemplateGroup(t,e){this._initErrorTemplates();const i=t.hash;if(this._symbolToTemplate.has(i))return this._symbolToTemplate.get(i);const s=new Array;e&&this._createMeshTemplates(s,e,!0),this._createMeshTemplates(s,t,!1);const r=this._createGroupId("expanded-cim"===t.type);return this._idToTemplateGroup.set(r,s),this._symbolToTemplate.set(i,r),r}getTemplateGroup(t){return this._idToTemplateGroup.has(t)?this._idToTemplateGroup.get(t):qi}getDynamicTemplateGroup(t){return this._idToTemplateGroup.has(t)?($i(t)||ji.error("mapview-template-store",`Id ${t} does not refer to a dynamic template`),this._idToTemplateGroup.get(t)):qi}getMosaicItem(t,e){const i=this._createTemplateId(),s=z((t=>this._idToResolver.set(i,t)));return this._fetchQueue.push({symbol:t,id:i,glyphIds:e}),s}finalize(t){return this._fetchQueue.length||this._lock.isHeld()?function(t,e,i){return t.acquire().then((()=>e(i))).then((()=>t.release())).catch((e=>{throw t.release(),e}))}(this._lock,this._fetchAllQueuedResources.bind(this),t):P()}_initErrorTemplates(){this._errorTemplates||(this._errorTemplates={fill:this._createMeshTemplates([],It(I),!1),marker:this._createMeshTemplates([],It(O),!1),line:this._createMeshTemplates([],It(R),!1)})}_fetchAllQueuedResources(t){if(!this._fetchQueue.length)return P();const i=this._fetchQueue,s=this._cimAnalyses;return this._fetchQueue=[],this._cimAnalyses=[],a(s).then((()=>this._fetchResource(i,t).then((t=>{for(const{id:e,mosaicItem:i}of t)this._idToResolver.get(e)(i),this._idToResolver.delete(e)})))).catch((t=>{A(t)?this._fetchQueue=this._fetchQueue.concat(i):function(t){return"worker:port-closed"===t.name}(t)||ji.error(new e("mapview-template-store","Unable to fetch requested texture resources",t))}))}_createGroupId(t){return this._idCounter++<<1|(t?1:0)}_createTemplateId(){return this._templateIdCounter++}async _createSMS(t){const{spriteMosaicItem:e}=await this.getMosaicItem(t);return ne(e,ji)?je.fromSimpleMarker(t,e):this._markerError}async _createPMS(t){const{spriteMosaicItem:e}=await this.getMosaicItem(t);return ne(e,ji)?je.fromPictureMarker(t,e):this._markerError}async _createSFS(t,e){const{spriteMosaicItem:i}=await this.getMosaicItem(t);return ne(i,ji)?Ki.fromSimpleFill(t,i,e):this._fillError}async _createPFS(t,e){const{spriteMosaicItem:i}=await this.getMosaicItem(t);return ne(i,ji)?Ki.fromPictureFill(t,i,e):this._fillError}async _createSLS(t,e){const{spriteMosaicItem:i}=await this.getMosaicItem(t);return ne(i,ji)?Zi.fromSimpleLine(t,i,this._joinOnUTurn):this._lineError}async _createLMS(t){const{spriteMosaicItem:e}=await this.getMosaicItem(t);return ne(e,ji)?je.fromLineSymbolMarker(t,e):this._markerError}async _createTS(t){const{glyphMosaicItems:e}=await this.getMosaicItem(t);return Ze.fromText(t,e)}async _createCIMText(t){const{glyphMosaicItems:e}=await this.getMosaicItem(t.cim,Wi(t.text));return t.cim.mosaicHash=t.materialHash,ne(e,ji)?Ze.fromCIMText(t,e):this._textError}async _createCIMFill(t){t.cim.mosaicHash=t.materialHash;const{spriteMosaicItem:e}=await this.getMosaicItem(t.cim);return ne(e,ji)?Ki.fromCIMFill(t,e):this._fillError}async _createCIMLine(t){t.cim.mosaicHash=t.materialHash;const{spriteMosaicItem:e}=await this.getMosaicItem(t.cim);return ne(e,ji)?Zi.fromCIMLine(t,e,this._joinOnUTurn):this._lineError}async _createCIMMarker(t){t.cim.mosaicHash=t.materialHash;const{spriteMosaicItem:e}=await this.getMosaicItem(t.cim);return ne(e,ji)?je.fromCIMMarker(t,e):this._markerError}async _createCIM(t){const e=t.templateHash;if(this._cimTemplateCache.has(e))return this._cimTemplateCache.get(e);let i;switch(t.type){case"marker":i=this._createCIMMarker(t);break;case"line":i=this._createCIMLine(t);break;case"fill":i=this._createCIMFill(t);break;case"text":i=this._createCIMText(t)}return i.then((t=>this._cimTemplateCache.set(e,t))),i}_createDynamicCIM(t){const e=t.templateHash;if(this._cimTemplateCache.has(e))return this._cimTemplateCache.get(e);let i;switch(t.type){case"marker":i=Hi.fromCIMMarker(t);break;case"line":i=Gi.fromCIMLine(t);break;case"fill":i=ki.fromCIMFill(t);break;case"text":i=Ei.fromCIMText(t)}return this._cimTemplateCache.set(e,i),i}_createPrimitiveMeshTemplates(t,e,i){switch(e.type){case"esriSMS":return Ji(t,this._createSMS(e));case"esriPMS":return Ji(t,this._createPMS(e));case"esriSFS":return Ji(t,this._createSFS(e,i));case"line-marker":return Ji(t,this._createLMS(e));case"esriPFS":return Ji(t,this._createPFS(e,i));case"esriSLS":return Ji(t,this._createSLS(e,!1));case"esriTS":return Ji(t,this._createTS(e));default:return ji.error("Unable to create mesh template for unknown symbol type {: $ }{symbol.type}"),t}}_createMeshTemplates(t,e,i){if(-1!==e.type.indexOf("3d"))return ji.error("3D symbols are not supported with MapView"),t;if("expanded-cim"===e.type){for(const i of e.layers)"function"==typeof i.materialHash?t.push(this._createDynamicCIM(i)):Ji(t,this._createCIM(i));return t}if("composite-symbol"===e.type){for(const s of e.layers)this._createPrimitiveMeshTemplates(t,s,i);return t}return"cim"===e.type||"label"===e.type||"web-style"===e.type?t:this._createPrimitiveMeshTemplates(t,e,i)}}class ts{constructor(t,e){this.data=t,this.stride=e}get vertexCount(){const t=this.stride/4,e=this.data.length/t;return e!==(0|e)&&console.debug("Corrupted stride"),e}transfer(t,e){const i=this.data.buffer();t.vertexCount=this.vertexCount,t.data=i,t.stride=this.stride,e.push(i)}}class es{constructor(t,e,i=!1){this.geometryType=t,this.indexVector=new Kt(Uint32Array,6*e),this.namedVectors={};const s=rt(t,i);for(const t in s){const i=s[t];let r;switch(i%4){case 0:case 2:r=new Kt(Uint32Array,i*e);break;case 1:case 3:r=new Kt(Uint8Array,i*e)}this.namedVectors[t]=new ts(r,i)}}get(t){return this.namedVectors[t].data}getVector(t){return this.namedVectors[t]}transfer(t,e){const i=this.indexVector.buffer(),s={};e.push(i);for(const t in this.namedVectors){const i=this.namedVectors[t];s[t]={},i.transfer(s[t],e)}t.geometryType=this.geometryType,t.indexBuffer=i,t.namedBuffers=s,this.destroy()}intoBuffers(){const t=Yt.fromVertexVectors(this);return this.destroy(),t}destroy(){this.indexVector=null,this.namedVectors=null}}function is(t){return t.length-1}function ss(t,e,i=1){const[s,r]=function(t,e){return t[e+1]}(t,e);return Math.sqrt(s*s+r*r)*i}class rs{constructor(t,e,i,s,r){this._segments=t,this._index=e,this._distance=i,this._xStart=s,this._yStart=r,this._done=!1}static create(t){return new rs(t,0,0,t[0][0],t[0][1])}clone(){return new rs(this._segments,this._index,this._distance,this.xStart,this.yStart)}equals(t){return this._index===t._index||t._index===this._index-1&&(0===this._distance||1===t._distance)||t._index===this._index+1&&(1===this._distance||0===t._distance)}leq(t){return this._index<t._index||this._index===t._index&&this._distance<=t._distance}geq(t){return this._index>t._index||this._index===t._index&&this._distance>=t._distance}get _segment(){return this._segments[this._index+1]}get angle(){const t=this.dy,e=(0*t+-1*-this.dx)/(1*this.length);let i=Math.acos(e);return t>0&&(i=2*Math.PI-i),i}get xStart(){return this._xStart}get yStart(){return this._yStart}get x(){return this.xStart+this.distance*this.dx}get y(){return this.yStart+this.distance*this.dy}get dx(){return this._segment[0]}get dy(){return this._segment[1]}get xMidpoint(){return this.xStart+.5*this.dx}get yMidpoint(){return this.yStart+.5*this.dy}get xEnd(){return this.xStart+this.dx}get yEnd(){return this.yStart+this.dy}get length(){const{dx:t,dy:e}=this;return Math.sqrt(t*t+e*e)}get remainingLength(){return this.length*(1-this._distance)}get backwardLength(){return this.length*this._distance}get distance(){return this._distance}get done(){return this._done}hasPrev(){return this._index-1>=0}hasNext(){return this._index+1<is(this._segments)}next(){return this.hasNext()?(this._xStart+=this.dx,this._yStart+=this.dy,this._distance=0,this._index+=1,this):null}prev(){return this.hasPrev()?(this._index-=1,this._xStart-=this.dx,this._yStart-=this.dy,this._distance=1,this):(this._done=!0,null)}_seekBackwards(t,e){const i=this.backwardLength;if(t<=i)return this._distance=(i-t)/this.length,this;let s=this.backwardLength;for(;this.prev();){if(s+this.length>t)return this._seekBackwards(t-s);s+=this.length}return this._distance=0,e?this:null}seek(t,e=!1){if(t<0)return this._seekBackwards(Math.abs(t),e);if(t<=this.remainingLength)return this._distance=(this.backwardLength+t)/this.length,this;let i=this.remainingLength;for(;this.next();){if(i+this.length>t)return this.seek(t-i,e);i+=this.length}return this._distance=1,e?this:null}}function ns(t,e,i){const s=function(t){let e=0;for(let i=0;i<is(t);i++)e+=ss(t,i);return e}(t),r=rs.create(t),n=s/2,o=(s-e)/2,a=Math.floor(o/e),l=n-a*e;r.seek(l);for(let t=-a;t<=a;t++)r.x<512&&r.x>=0&&r.y<512&&r.y>=0&&i(r.clone(),t,n+t*e,s),r.seek(e)}function os(t,e){const i=1e-6;if(e<=0)return;const s=t.length;if(s<3)return;const r=[];let n=0;r.push(0);for(let e=1;e<s;e++)n+=dt(t[e],t[e-1]),r.push(n);e=Math.min(e,.2*n);const o=[];o.push(t[0][0]),o.push(t[0][1]);const a=t[s-1][0],l=t[s-1][1],h=pt([0,0],t[0],t[1]);yt(h),t[0][0]+=e*h[0],t[0][1]+=e*h[1],pt(h,t[s-1],t[s-2]),yt(h),t[s-1][0]+=e*h[0],t[s-1][1]+=e*h[1];for(let t=1;t<s;t++)r[t]+=e;r[s-1]+=e;const c=.5*e;for(let n=1;n<s-1;n++){let a=0,l=0,h=0;for(let s=n-1;s>=0&&!(r[s+1]<r[n]-c);s--){const o=c+r[s+1]-r[n],f=r[s+1]-r[s],u=r[n]-r[s]<c?1:o/f;if(Math.abs(u)<i)break;const m=u*u,d=u*o-.5*m*f,p=u*f/e,y=t[s+1],_=t[s][0]-y[0],g=t[s][1]-y[1];a+=p/d*(y[0]*u*o+.5*m*(o*_-f*y[0])-m*u*f*_/3),l+=p/d*(y[1]*u*o+.5*m*(o*g-f*y[1])-m*u*f*g/3),h+=p}for(let o=n+1;o<s&&!(r[o-1]>r[n]+c);o++){const s=c-r[o-1]+r[n],f=r[o]-r[o-1],u=r[o]-r[n]<c?1:s/f;if(Math.abs(u)<i)break;const m=u*u,d=u*s-.5*m*f,p=u*f/e,y=t[o-1],_=t[o][0]-y[0],g=t[o][1]-y[1];a+=p/d*(y[0]*u*s+.5*m*(s*_-f*y[0])-m*u*f*_/3),l+=p/d*(y[1]*u*s+.5*m*(s*g-f*y[1])-m*u*f*g/3),h+=p}o.push(a/h),o.push(l/h)}o.push(a),o.push(l);for(let e=0,i=0;e<s;e++)t[e][0]=o[i++],t[e][1]=o[i++]}const as=i.getLogger("esri.views.2d.engine.webgl.WGLLabelTemplate"),ls=function(t){const e=new Map;return t=>(e.has(t)||e.set(t,(t=>{let e=0;if(0===t)return 1/0;for(;!(t%2);)e++,t/=2;return e})(t)),e.get(t))}(),hs=t=>Math.floor(127*t+127),cs=t=>Math.floor(10*t),fs=t=>Math.round(t*(254/360)),us=(t,e)=>et(Math.round(8*t),Math.round(8*e));class ms extends Ze{constructor(t,e,i,s){super(t,i.font.size,i.haloSize||0,i.color&&nt(i.color)||0,i.haloColor&&nt(i.haloColor)||0,i.horizontalAlignment,i.verticalAlignment,Ct(e.labelPlacement)?1:0,i.font.decoration,!1,i.angle||0,i.xoffset,i.yoffset,i.lineWidth,i.lineHeight,null,null),this._outLineLabelAngle=0,this._refPlacementPadding=0,this._refPlacementDirX=0,this._refPlacementDirY=0,this._refOffsetX=0,this._refOffsetY=0,this.geometryType=Q.LABEL;const n=function(t,e){const i=!!t.minScale&&e.scaleToZoom(t.minScale)||0;return N(i,0,25.5)}(e,s),o=function(t,e){const i=!!t.maxScale&&e.scaleToZoom(t.maxScale)||255;return N(i,0,25.5)}(e,s),a=e.labelPlacement,[l,h]=Ht(a);this._xAlignD=l,this._yAlignD=h,this._minZoom=n,this._maxZoom=o,this._refPlacementPadding=r(i.haloSize)+q;const c=Lt.load(t);c.sdf=!0,this._materialKey=c.data}static fromLabelClass(t,e){if("center-along"===t.labelPlacement){const e=t.symbol;e.xoffset=0,e.yoffset=0,e.angle=0,e.font.decoration="none"}return new ms(t.materialKey,t,t.symbol,e)}get _shapedBox(){return d(this._shapingInfo).bounds}bindReferenceTemplate(t){let e=Wt(this._xAlignD),i=Et(this._yAlignD);if(this._refOffsetX=0,this._refOffsetY=0,m(t))return void(this._refSymbolAndPlacementOffset=tt(0,0,hs(e),hs(i)));if("circle"===t.boundsType&&(e||i)){const t=Math.sqrt(e*e+i*i);e/=t,i/=t}const s=Math.max(t.height,t.width),r=4*this._refPlacementPadding;this._refSymbolAndPlacementOffset=tt(r,s,hs(e),hs(i)),this._referenceSize=s,this._refPlacementDirX=e,this._refPlacementDirY=i,this._refOffsetX=t.xOffset,this._refOffsetY=t.yOffset}writeMesh(t,i,s,r,n,o){if(m(this._shapingInfo))return;const a=new Array,l=this._shapingInfo,h="esriGeometryPolygon"===s.geometryType?s.readLegacyCentroid():s.readLegacyGeometry();if(h){switch(this.current={out:t,outVecs:i,outMetrics:a,inId:n,inShaping:l,zoomLevel:o},r){case"esriGeometryPolyline":this._placeLineLabels(h);break;case"esriGeometryPoint":case"esriGeometryPolygon":this._placePointLabels(h);break;default:((t,i="mapview-labeling")=>{as.error(new e(i,t))})("mapview-labeling",`Geometry of type ${r} is not supported`)}t.writeMetrics(this.current.outMetrics)}}_isVisible(t,e){const i=cs(this.current.zoomLevel);return cs(t)<=i&&i<=cs(e)}_placePointLabels(t){const{out:e,outVecs:i,outMetrics:s,inId:r}=this.current;this._writeGlyphs(e,i,r,t,s)}_placeLineLabels(t){const e=function(t,e){const i=e;for(let e=0;e<t.length;e++){let s=t[e];const r=[];r.push(s[0]);for(let t=1;t<s.length;t++){let[e,i]=r[t-1];e+=s[t][0],i+=s[t][1],r.push([e,i])}os(r,i);const n=[];n.push(r[0]);for(let t=1;t<r.length;t++){const[e,i]=r[t-1],[s,o]=r[t],a=Math.round(s-e),l=Math.round(o-i);n.push([a,l])}t[e]=n,s=n}return t}(t.paths,this.current.inShaping.bounds.width),i=this._placeSubdivGlyphs.bind(this),s=(this._shapedBox.width+128)/4;for(const t of e)ns(t,s,i)}_placeSubdivGlyphs(t,e,i,s){const r=ls(e),n=this._shapedBox.width/4,o=Math.min(i,s-i),a=F(o/(4+n/2)),l=0===e?a:Math.min(r,a),h=Math.max(this._minZoom,this.current.zoomLevel+2-l),c=this.current.zoomLevel-h,f=this._shapedBox.width/2*Math.pow(2,c);this.current.inShaping.isMultiline?0===e&&this._placeStraight(t,h):this._placeCurved(t,h,f)}_placeStraight(t,e){const{out:i,outVecs:s,outMetrics:r,inId:n}=this.current;this._writeGlyphs(i,s,n,t,r,e)}_placeCurved(t,e,i){const s={from:this.current.out.currentDisplayRecordCount(),count:-1},r=new Zt(this.current.inId,s,t.x,t.y,e),n=t.clone(),o=t.angle*(180/Math.PI)%360,a=(t.angle*(180/Math.PI)+180)%360;this._outLineLabelAngle=fs(o),this._placeFirst(n,r,e,1),this._placeBack(t,n,r,e,i,1),this._placeForward(t,n,r,e,i,1),this._outLineLabelAngle=fs(a),this._placeFirst(n,r,e,0),this._placeBack(t,n,r,e,i,0),this._placeForward(t,n,r,e,i,0),r.range.count=this.current.out.currentDisplayRecordCount()-r.range.from,r.bounds&&this.current.outMetrics.push(r)}_placeBack(t,e,i,s,r,n){const o=t.clone();let a=t.backwardLength+0;for(;o.prev()&&!(a>=r);)this._placeOnSegment(o,e,i,a,s,-1,n),a+=o.length+0}_placeForward(t,e,i,s,r,n){const o=t.clone();let a=t.remainingLength+0;for(;o.next()&&!(a>=r);)this._placeOnSegment(o,e,i,a,s,1,n),a+=o.length+0}_placeFirst(t,e,i,s){const r=t,n=this.current.inShaping,o=n.glyphs,a=this.current.zoomLevel,{out:l,outVecs:h,inId:c}=this.current,f=us(r.x,r.y);for(const r of o){const o=r.x>n.bounds.x?s:1-s,u=o*t.remainingLength+(1-o)*t.backwardLength,m=Math.abs(r.x+r.width/2-n.bounds.x),d=Math.max(0,a+F(m/(u+0))),p=Math.max(i,d);r.maxZoom=25,r.angle=t.angle+(1-s)*Math.PI,r.minZoom=p,this._writeGlyph(l,h,r,c,f),s&&this._isVisible(r.minZoom,r.maxZoom)&&e.add(r.bounds,0,0)}}_placeOnSegment(t,e,i,s,r,n,o){const a=this.current.inShaping.glyphs,{out:l,outVecs:h,inId:c}=this.current,f=this.current.inShaping,u=this.current.zoomLevel,m=t.dx/t.length,d=t.dy/t.length,p={x:t.x+s*-n*m,y:t.y+s*-n*d},y=us(p.x,p.y);for(const m of a){const a=m.x>f.bounds.x?o:1-o;if(!(a&&1===n||!a&&-1===n))continue;const d=Math.abs(m.x+m.width/2-f.bounds.x),p=Math.max(0,u+F(d/s)-.1),_=Math.max(r,u+F(d/(s+t.length+0)));0!==p&&(m.angle=t.angle+(1-o)*Math.PI,m.minZoom=_,m.maxZoom=p,this._writeGlyph(l,h,m,c,y),o&&this._isVisible(m.minZoom,m.maxZoom)&&i.add(m.bounds,t.x-e.x,t.y-e.y))}}_writeGlyphs(t,e,i,s,r,n=this._minZoom){const o=this._shapingInfo;if(m(o))return;if(s.x<0||s.x>=512||s.y<0||s.y>=512)return;const a=t.currentDisplayRecordCount(),l=us(s.x+this._refOffsetX,s.y-this._refOffsetY),h=new Zt(i,{from:a,count:-1},s.x+this._refOffsetX,s.y-this._refOffsetY,n);for(const s of o.glyphs)s.minZoom=n,s.maxZoom=this._maxZoom,this._writeGlyph(t,e,s,i,l);h.range.count=t.currentDisplayRecordCount()-h.range.from,h.bounds=o.boundsT;const c=Lt.load(this._materialKey),f=this._refPlacementDirX,u=this._refPlacementDirY,d=c.vvSizeFieldStops||c.vvSizeMinMaxValue||c.vvSizeScaleStops||c.vvSizeUnitValue;h.setPlacementOffset(d,this._referenceSize,this._refPlacementPadding,f,u),r.push(h)}_writeGlyph(t,e,i,s,r){const n=Mt.load(this._materialKey);n.textureBinding=i.textureBinding;const o=e.indexVector.length,a=e.getVector("geometry").vertexCount,l=this._writeIndices(e),h=this._writeVertex(e,s,r,i);t.writeDisplayRecord(this.geometryType,n.data,a,h,o,l)}_writeVertexCommon(t,e,i,s){const r=this._color,n=this._haloColor,o=tt(0,0,this._size,this._haloSize),a=Math.max(s.minZoom,this._minZoom),l=Math.min(s.maxZoom,this._maxZoom),h=tt(cs(a),cs(l),this._outLineLabelAngle,0);t.push(i),t.push(e),t.push(r),t.push(n),t.push(o),t.push(this._refSymbolAndPlacementOffset),t.push(h)}}class ds{constructor(t,e,i){this._isDD=!1,this._geometryType=t,this._idField=e,this._templateStore=i}update(t,e){this._isDD="simple"===t.mesh.matcher.type&&t.mesh.matcher.isDotDensity,u(t.mesh.labels)&&this._setLabelTemplates(t.mesh.labels,e)}_setLabelTemplates(t,e){this._labelTemplates=t.map((t=>ms.fromLabelClass(t,e)))}get templates(){return this._templateStore}createMeshData(t){const e=new Array(5),i=this._labelTemplates&&this._labelTemplates.length>0,s="esriGeometryPolyline"===this._geometryType?J:$;return e[Q.MARKER]=new es(Q.MARKER,4*t),e[Q.FILL]=new es(Q.FILL,t,this._isDD),e[Q.LINE]=new es(Q.LINE,t),e[Q.TEXT]=new es(Q.TEXT,4*t),e[Q.LABEL]=new es(Q.LABEL,i?4*s:0),new Ut(e,{features:t,records:t,metrics:0})}async analyze(t,e,i,s,r){if(D(r))return;let n;"dictionary"===e.type&&(n=await e.analyze(this._idField,t.copy(),i,s,r));let o=0;for(;t.next();){let r;if(r=n?n[o++]:e.match(this._idField,t,this._geometryType,i,s),t.setGroupId(r),$i(r)){const e=this._templateStore.getDynamicTemplateGroup(r);for(const r of e)r&&r.analyze&&r.analyze(this._templateStore,t,i,s)}}return this._templateStore.finalize(r)}async analyzeGraphics(t,e,i,s,r){if(D(r))return;const n=t.getCursor();for(e&&await e.analyze(this._idField,n.copy(),i,s,r);n.next();){let t=n.getGroupId();if(null!=t&&-1!==t||(t=e.match(this._idField,n,n.geometryType,i,s),n.setGroupId(t)),$i(t)){const e=this._templateStore.getDynamicTemplateGroup(t);for(const t of e)t&&t.analyze&&t.analyze(this._templateStore,n,i,s)}n.setGroupId(t)}return this._templateStore.finalize(r)}writeGraphic(t,e){const i=e.getGroupId(),s=e.getDisplayId(),r=this._templateStore.getTemplateGroup(i),n=e.geometryType;if(null!=s){if($i(i))for(const t of r)t.bindFeature(e,null,null);if(r){t.writeDisplayObject(s,e.readGraphic().insertAfter);for(const i of r){if(!i)continue;const r=t.get(i.geometryType);i.writeMesh(t,r,e,n,s)}}}}writeCursor(t,e,i,s,r,n){const o=e.getGroupId(),a=e.getDisplayId(),l=this._templateStore.getTemplateGroup(o);if(null==a)return;if(!l)return;if(t.writeDisplayObject(a,0),$i(o))for(const t of l)t.bindFeature(e,i,s);for(const i of l){const s=t.get(i.geometryType);!i.needsPixelBuffer&&e.hasFilter()||i.writeMesh(t,s,e,this._geometryType,a)}const h=t.hasDisplayRecords();if(u(n)&&h){const i=n&&this._findLabelRef(l);this._writeLabels(t,e,a,n,i,r)}t.endDisplayObject()}_findLabelRef(t){for(const e of t)if(e instanceof je)return e;return null}_writeLabels(t,e,i,s,r,n){for(const o of s)if(u(o)&&o){const{glyphs:s,rtl:a,index:l}=o,h=this._labelTemplates[l],c=t.get(h.geometryType);h.bindReferenceTemplate(r),h.bindTextInfo(s,a),h.writeMesh(t,c,e,this._geometryType,i,n)}}}export{Qi as L,Jt as a,ne as e,se as f,ds as m,Ne as n,Qt as r,He as s,Wi as t};
