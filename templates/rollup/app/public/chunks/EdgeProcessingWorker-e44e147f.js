import{bp as t,eb as e,ec as n,a0 as o,bH as r,ed as s,ee as i,ef as a,eg as c,eh as l,a1 as f,ei as u,ej as g,ek as d,el as p,em as m}from"../main.js";import{A as h,f as w,u as y,a as v,p as A,c as I,o as b,i as N,m as S,T as U,d as E,b as V,l as x,h as L,e as M,O as W,x as k,g as D,w as B,E as F,L as j,F as z,I as P,U as T,j as C,V as _,M as q,S as O,k as R,q as H,v as $,z as G,B as J,C as K,D as Q,G as X,H as Y}from"./InterleavedLayout-46517429.js";import"./vec4-28f36952.js";function Z(e,n,o){const r=e.byteLength/(4*n),s=new Uint32Array(e,0,r*n);let i=new Uint32Array(r);const a=o&&o.minReduction||0,c=o&&o.originalIndices||null,l=o&&o.componentOffsets||null;let f=0;if(l)for(let t=0;t<l.length-1;t++){const e=l[t+1]-l[t];e>f&&(f=e)}else f=r;const u=Math.floor(1.1*f)+1;(null==ot||ot.length<2*u)&&(ot=new Uint32Array(t(2*u)));for(let t=0;t<2*u;t++)ot[t]=0;let g=0;const d=!!l&&!!c,p=d?c.length:r,m=d?new Uint32Array(c.length):null,h=1.96;let w=0!==a?Math.ceil(4*h*h/(a*a)*a*(1-a)):p,y=1,v=l?l[1]:p;for(let t=0;t<p;t++){if(t===w){const e=1-g/t;if(e+h*Math.sqrt(e*(1-e)/t)<a)return null;w*=2}if(t===v){for(let t=0;t<2*u;t++)ot[t]=0;if(c)for(let t=l[y-1];t<l[y];t++)m[t]=i[c[t]];v=l[++y]}const e=d?c[t]:t,o=e*n,r=nt(s,o,n);let f=r%u,p=g;for(;0!==ot[2*f+1];){if(ot[2*f]===r){const t=ot[2*f+1]-1;if(tt(s,o,t*n,n)){p=i[t];break}}f++,f>=u&&(f-=u)}p===g&&(ot[2*f]=r,ot[2*f+1]=e+1,g++),i[e]=p}if(0!==a&&1-g/r<a)return null;if(d){for(let t=l[y-1];t<m.length;t++)m[t]=i[c[t]];i=m}const A=new Uint32Array(n*g);g=0;for(let t=0;t<p;t++)i[t]===g&&(et(s,(d?c[t]:t)*n,A,g*n,n),g++);if(c&&!d){const t=new Uint32Array(c.length);for(let e=0;e<t.length;e++)t[e]=i[c[e]];i=t}return{buffer:A.buffer,indices:i,uniqueCount:g}}function tt(t,e,n,o){for(let r=0;r<o;r++)if(t[e+r]!==t[n+r])return!1;return!0}function et(t,e,n,o,r){for(let s=0;s<r;s++)n[o+s]=t[e+s]}function nt(t,e,n){let o=0;for(let r=0;r<n;r++)o=t[e+r]+o|0,o=o+(o<<11)+(o>>>2)|0;return o>>>0}let ot=null;const rt={divisor:0};function st(t,e={}){e={...rt,...e};const n=t.stride;return t.fieldNames.filter((e=>{const n=t.fields.get(e).optional;return!(n&&n.glPadding)})).map((o=>{const r=t.fields.get(o),s=r.constructor.ElementCount,i=function(t){const e=it[t];if(e)return e;throw new Error("BufferType not supported in WebGL")}(r.constructor.ElementType),a=r.offset,c=!(!r.optional||!r.optional.glNormalized);return{name:o,stride:n,count:s,type:i,offset:a,normalized:c,divisor:e.divisor}}))}const it={u8:5121,u16:5123,u32:5125,i8:5120,i16:5122,i32:5124,f32:5126},at=h().vec3f("position").u16("componentIndex").u16("_padding"),ct=(st(h().vec2u8("sideness")),h().vec3f("position0").vec3f("position1").u16("componentIndex").u8("variantOffset",{glNormalized:!0}).u8("variantStroke").u8("variantExtension",{glNormalized:!0}).u8("_padding",{glPadding:!0}).u16("_padding2",{glPadding:!0})),lt=ct.clone().vec3f("normal"),ft=ct.clone().vec3f("normalA").vec3f("normalB");class ut{updateSettings(t){this.settings=t}write(t,e,n){const o=function(t){const e=gt;e[0]=t.position0[0],e[1]=t.position0[1],e[2]=t.position0[2],e[3]=t.position1[0],e[4]=t.position1[1],e[5]=t.position1[2],pt[0]=5381;for(let t=0;t<dt.length;t++)pt[0]=31*pt[0]+dt[t];return pt[0]}(n);mt.seed=o;const r=mt.getIntRange(0,255),s=mt.getIntRange(0,this.settings.variants-1),i=mt.getFloat(),a=255*(.5*function(t,e){const n=t<0?-1:1;return Math.pow(Math.abs(t),1.2)*n}(-(1-Math.min(i/.7,1))+Math.max(0,i-.7)/(1-.7))+.5);t.position0.setVec(e,n.position0),t.position1.setVec(e,n.position1),t.componentIndex.set(e,n.componentIndex),t.variantOffset.set(e,r),t.variantStroke.set(e,s),t.variantExtension.set(e,a)}trim(t,e){return t.slice(0,e)}}const gt=new Float32Array(6),dt=new Uint32Array(gt.buffer),pt=new Uint32Array(1),mt=new r;class ht{constructor(){this.commonWriter=new ut}updateSettings(t){this.commonWriter.updateSettings(t)}allocate(t){return lt.createBuffer(t)}write(t,o,r){this.commonWriter.write(t,o,r),e(yt,r.faceNormal0,r.faceNormal1),n(yt,yt),t.normal.setVec(o,yt)}trim(t,e){return this.commonWriter.trim(t,e)}}ht.Layout=lt,ht.glLayout=st(lt,{divisor:1});class wt{constructor(){this.commonWriter=new ut}updateSettings(t){this.commonWriter.updateSettings(t)}allocate(t){return ft.createBuffer(t)}write(t,e,n){this.commonWriter.write(t,e,n),t.normalA.setVec(e,n.faceNormal0),t.normalB.setVec(e,n.faceNormal1)}trim(t,e){return this.commonWriter.trim(t,e)}}wt.Layout=ft,wt.glLayout=st(ft,{divisor:1});const yt=o();function vt(t,e){return e.push(t.buffer),{buffer:t.buffer,layout:At(t.layout)}}function At(t){const e=new Array;return t.fields.forEach(((t,n)=>{const o={...t,constructor:bt(t.constructor)};e.push([n,o])})),{stride:t.stride,fields:e,fieldNames:t.fieldNames}}const It=[w,y,v,A,I,b,N,S,U,E,V,x,L,M,W,k,D,B,F,j,z,P,T,C,_,q,O,R,H,$,G,J,K,Q,X,Y];function bt(t){return`${t.ElementType}_${t.ElementCount}`}const Nt=new Map;function St(t,e){const n=t.length/3,o=new Uint32Array(e+1),r=new Uint32Array(e+1),s=(t,e)=>{t<e?o[t+1]++:r[e+1]++};for(let e=0;e<n;e++){const n=t[3*e],o=t[3*e+1],r=t[3*e+2];s(n,o),s(o,r),s(r,n)}let i=0,a=0;for(let t=0;t<e;t++){const e=o[t+1],n=r[t+1];o[t+1]=i,r[t+1]=a,i+=e,a+=n}const c=new Uint32Array(6*n),l=o[e],f=(t,e,n)=>{if(t<e){const r=o[t+1]++;c[2*r]=e,c[2*r+1]=n}else{const o=r[e+1]++;c[2*l+2*o]=t,c[2*l+2*o+1]=n}};for(let e=0;e<n;e++){const n=t[3*e],o=t[3*e+1],r=t[3*e+2];f(n,o,e),f(o,r,e),f(r,n,e)}const u=(t,e)=>{const n=2*t,o=e-t;for(let t=1;t<o;t++){const e=c[n+2*t],o=c[n+2*t+1];let r=t-1;for(;r>=0&&c[n+2*r]>e;r--)c[n+2*r+2]=c[n+2*r],c[n+2*r+3]=c[n+2*r+1];c[n+2*r+2]=e,c[n+2*r+3]=o}};for(let t=0;t<e;t++)u(o[t],o[t+1]),u(l+r[t],l+r[t+1]);const g=new Int32Array(3*n),d=(e,n)=>e===t[3*n]?0:e===t[3*n+1]?1:e===t[3*n+2]?2:-1,p=(t,e)=>{const n=d(t,e);g[3*e+n]=-1},m=(t,e,n,o)=>{const r=d(t,e);g[3*e+r]=o;const s=d(n,o);g[3*o+s]=e};for(let t=0;t<e;t++){let e=o[t];const n=o[t+1];let s=r[t];const i=r[t+1];for(;e<n&&s<i;){const n=c[2*e],o=c[2*l+2*s];n===o?(m(t,c[2*e+1],o,c[2*l+2*s+1]),e++,s++):n<o?(p(t,c[2*e+1]),e++):(p(o,c[2*l+2*s+1]),s++)}for(;e<n;)p(t,c[2*e+1]),e++;for(;s<i;)p(c[2*l+2*s],c[2*l+2*s+1]),s++}return g}function Ut(t,e){return t.cosAngle<e}function Et(t,e){return t.cosAngle>e}function Vt(t,e){const n=d(t.cosAngle),o=xt.fwd,r=xt.ortho;return p(o,t.position1,t.position0),n*(g(a(r,t.faceNormal0,t.faceNormal1),o)>0?-1:1)>e}It.forEach((t=>Nt.set(bt(t),t)));const xt={edge:{position0:o(),position1:o(),faceNormal0:o(),faceNormal1:o(),componentIndex:0,cosAngle:0},ortho:o(),fwd:o()},Lt={v0:o(),v1:o(),v2:o()},Mt={anglePlanar:4,angleSignificantEdge:35};async function Wt(t){const e=function(t){return{data:at.createView(t.dataBuffer),originalIndices:"Uint32Array"===t.originalIndicesType?new Uint32Array(t.originalIndicesBuffer):"Uint16Array"===t.originalIndicesType?new Uint16Array(t.originalIndicesBuffer):void 0,writerSettings:t.writerSettings,skipDeduplicate:t.skipDeduplicate}}(t),n=kt(e),o=[e.data.buffer];return{result:function(t,e){return e.push(t.regular.lodInfo.lengths.buffer),e.push(t.silhouette.lodInfo.lengths.buffer),{regular:{instancesData:vt(t.regular.instancesData,e),lodInfo:{lengths:t.regular.lodInfo.lengths.buffer}},silhouette:{instancesData:vt(t.silhouette.instancesData,e),lodInfo:{lengths:t.silhouette.lodInfo.lengths.buffer}},averageEdgeLength:t.averageEdgeLength}}(n,o),transferList:o}}function kt(t){const e=function(t,e,n){if(e&&n)return{faces:n,neighbors:St(n,t.count),vertices:t};{const e=Z(t.buffer,t.stride/4,{originalIndices:n}),o=St(e.indices,e.uniqueCount);return{faces:e.indices,neighbors:o,vertices:at.createView(e.buffer)}}}(t.data,t.skipDeduplicate,t.originalIndices);return Dt.updateSettings(t.writerSettings),Bt.updateSettings(t.writerSettings),function(t,e,o,r=Mt){const d=t.vertices.position,p=t.vertices.componentIndex,h=s(r.anglePlanar),w=s(r.angleSignificantEdge),y=Math.cos(w),v=Math.cos(h),A=xt.edge,I=A.position0,b=A.position1,N=A.faceNormal0,S=A.faceNormal1,U=function(t){const e=t.faces.length/3,o=t.vertices.position,r=t.faces,s=Lt.v0,c=Lt.v1,l=Lt.v2,f=new Float32Array(3*e);for(let t=0;t<e;t++){const e=r[3*t+0],u=r[3*t+1],g=r[3*t+2];o.getVec(e,s),o.getVec(u,c),o.getVec(g,l),i(c,c,s),i(l,l,s),a(s,c,l),n(s,s),f[3*t+0]=s[0],f[3*t+1]=s[1],f[3*t+2]=s[2]}return f}(t),E=function(t){const e=t.faces.length/3,n=t.faces,o=t.neighbors;let r=0;for(let t=0;t<e;t++){const e=o[3*t+0],s=o[3*t+1],i=o[3*t+2],a=n[3*t+0],c=n[3*t+1],l=n[3*t+2];r+=-1===e||a<c?1:0,r+=-1===s||c<l?1:0,r+=-1===i||l<a?1:0}const s=new Int32Array(4*r);let i=0;for(let t=0;t<e;t++){const e=o[3*t+0],r=o[3*t+1],a=o[3*t+2],c=n[3*t+0],l=n[3*t+1],f=n[3*t+2];(-1===e||c<l)&&(s[i++]=c,s[i++]=l,s[i++]=t,s[i++]=e),(-1===r||l<f)&&(s[i++]=l,s[i++]=f,s[i++]=t,s[i++]=r),(-1===a||f<c)&&(s[i++]=f,s[i++]=c,s[i++]=t,s[i++]=a)}return s}(t),V=E.length/4,x=e.allocate(V);let L=0;const M=V,W=o.allocate(M);let k=0,D=0,B=0;const F=c(0,V),j=new Float32Array(V);l(j,((t,e,n)=>{d.getVec(E[4*e+0],I),d.getVec(E[4*e+1],b),n[e]=m(I,b)})),F.sort(((t,e)=>j[e]-j[t]));const z=new Array,P=new Array;for(let t=0;t<V;t++){const n=F[t],r=j[n],s=E[4*n+0],i=E[4*n+1],a=E[4*n+2],c=E[4*n+3],l=-1===c;if(d.getVec(s,I),d.getVec(i,b),l)f(N,U[3*a+0],U[3*a+1],U[3*a+2]),u(S,N),A.componentIndex=p.get(s),A.cosAngle=g(N,S);else{if(f(N,U[3*a+0],U[3*a+1],U[3*a+2]),f(S,U[3*c+0],U[3*c+1],U[3*c+2]),A.componentIndex=p.get(s),A.cosAngle=g(N,S),Et(A,v))continue;A.cosAngle<-.9999&&u(S,N)}D+=r,B++,l||Ut(A,y)?(e.write(x,L++,A),z.push(r)):Vt(A,h)&&(o.write(W,k++,A),P.push(r))}const T=new Float32Array(z.reverse()),C=new Float32Array(P.reverse());return{regular:{instancesData:e.trim(x,L),lodInfo:{lengths:T}},silhouette:{instancesData:o.trim(W,k),lodInfo:{lengths:C}},averageEdgeLength:D/B}}(e,Dt,Bt)}const Dt=new ht,Bt=new wt;export{kt as work,Wt as wrappedWork};
